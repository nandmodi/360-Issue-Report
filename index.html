<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>360 Issue Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
  .header-bar { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 10px 0; text-align: center; font-weight: bold; font-size: 22px; z-index: 10000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .tabs { position: fixed; top: 48px; left: 0; right: 0; background: #fff; display: flex; border-bottom: 2px solid #ccc; z-index: 10000; }
  .tab { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; user-select: none; }
  .tab.active { color: #007bff; border-color: #007bff; }
  .filters { position: fixed; top: 88px; left: 0; right: 0; background: #f8f9fa; padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; border-bottom: 1px solid #ccc; z-index: 9999; }
  .filters select, .filters button { padding: 6px 10px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
  .filters button { background-color: #007bff; color: white; border: none; }
</style>
</head>
<body>

<div class="header-bar">360 Issue Dashboard</div>

<div class="tabs">
  <div class="tab active" data-tab="dashboardTab">Dashboard</div>
  <div class="tab" data-tab="summaryTab">Summary</div>
</div>

<div class="filters" id="filtersSection">
  <select id="monthFilter" data-label="Month"><option value="">Month</option></select>
  <select id="severityFilter" data-label="Severity"><option value="">Severity</option></select>
  <select id="issueFilter" data-label="Issue"><option value="">Issue</option></select>
  <select id="enterpriseFilter" data-label="Enterprise"><option value="">Enterprise</option></select>
  <select id="productTypeFilter" data-label="Product_Type"><option value="">Product Type</option></select>
  <select id="qcFilter" data-label="QC"><option value="">QC</option></select>
  <button onclick="resetFilters()">Reset</button>
</div>

<div class="summary-bar" id="summaryBar">
  <div>Total Marked Spin: <span id="markedSpin">0</span></div>
  <div>
    <button onclick="loadAndRender()" title="Refresh" style="background:none;border:none;cursor:pointer;font-size:18px;">ðŸ”„</button>
    <button onclick="exportTableToCSV('spin-data.csv')" title="Export CSV" style="background:none;border:none;cursor:pointer;font-size:18px;">ðŸ“¤</button>
  </div>
  <div>Total Received Spin: <span id="receivedSpin">0</span></div>
</div>
function applyFilters() {
  const filters = {
    Month: document.getElementById('monthFilter').value,
    Severity: document.getElementById('severityFilter').value,
    Issue: document.getElementById('issueFilter').value,
    Enterprise: document.getElementById('enterpriseFilter').value,
    Product_Type: document.getElementById('productTypeFilter').value,
    QC: document.getElementById('qcFilter').value
  };

  const markedMatch = row =>
    (!filters.Month || row['Month'] === filters.Month) &&
    (!filters.Severity || row['Severity'] === filters.Severity) &&
    (!filters.Issue || row['Issue'] === filters.Issue) &&
    (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
    (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
    (!filters.QC || row['QC'] === filters.QC);

  const receivedMatch = row =>
    (!filters.Month || row['Month'] === filters.Month) &&
    (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
    (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
    (!filters.QC || row['QC'] === filters.QC);

  const filteredMarked = globalData.filter(markedMatch);
  const filteredReceived = totalDataGlobal.filter(receivedMatch);

  const isRemoveBG = filters.Issue === "RemoveBG";

  if (isRemoveBG) {
    const removeBGSpins = filteredMarked.filter(r => r.Issue === "RemoveBG");
    document.getElementById('markedSpin').textContent = new Set(removeBGSpins.map(r => r['Spin_id'])).size;

    if (filters.Enterprise) {
      const receivedForEnterprise = totalDataGlobal.filter(r => 
        r['Enterprise'] === filters.Enterprise &&
        (!filters.Month || r['Month'] === filters.Month) &&
        (!filters.Product_Type || r['Product_Type'] === filters.Product_Type) &&
        (!filters.QC || r['QC'] === filters.QC)
      );
      document.getElementById('receivedSpin').textContent = new Set(receivedForEnterprise.map(r => r['Spin_id'])).size;
    } else {
      const allReceived = totalDataGlobal.filter(r => 
        (!filters.Month || r['Month'] === filters.Month) &&
        (!filters.Product_Type || r['Product_Type'] === filters.Product_Type) &&
        (!filters.QC || r['QC'] === filters.QC)
      );
      document.getElementById('receivedSpin').textContent = new Set(allReceived.map(r => r['Spin_id'])).size;
    }
  } else {
    document.getElementById('markedSpin').textContent = new Set(filteredMarked.map(r => r['Spin_id'])).size;
    document.getElementById('receivedSpin').textContent = new Set(filteredReceived.map(r => r['Spin_id'])).size;
  }

  populateSummarySection(filteredMarked);
  populateFilters(globalData);
  renderIssueTable(filteredMarked);
  renderEnterpriseIssueTable(filteredMarked);
  renderSpinTable(filteredMarked);
  renderPieChart(filteredMarked);
  renderBarChart(filteredMarked);
  renderSeverityTrendChart(filteredMarked);
  renderIssueTrendChart(filteredMarked);
  renderSeverityDetailsTable(filteredMarked);
  renderIssueDetailsTable(filteredMarked);
}
// continue from loadAndRender(), renderIssueTable(), all charts...

// Tabs switcher
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    const id = tab.getAttribute('data-tab');
    document.getElementById(id).classList.add('active');

    const showFilters = id === 'dashboardTab';
    document.getElementById('filtersSection').style.display = showFilters ? 'flex' : 'none';
    document.getElementById('summaryBar').style.display = showFilters ? 'flex' : 'none';
    document.getElementById('summarySection').style.display = showFilters ? 'flex' : 'none';
  });
});

window.onload = loadAndRender;
</script>
</body>
</html>
