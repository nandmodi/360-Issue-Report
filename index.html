<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>360 Issue Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
Â  /* Your CSS unchanged */
Â  body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
Â  .header-bar { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 10px 0; text-align: center; font-weight: bold; font-size: 22px; z-index: 10000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
Â  .tabs { position: fixed; top: 48px; left: 0; right: 0; background: #fff; display: flex; border-bottom: 2px solid #ccc; z-index: 10000; }
Â  .tab { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; user-select: none; }
Â  .tab.active { color: #007bff; border-color: #007bff; }
Â  .filters { position: fixed; top: 88px; left: 0; right: 0; background: #f8f9fa; padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; border-bottom: 1px solid #ccc; z-index: 9999; }
Â  .filters select, .filters button { padding: 6px 10px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
Â  .filters button { background-color: #007bff; color: white; border: none; }
Â  .summary-bar { position: fixed; top: 128px; left: 0; right: 0; background: #e2e6ea; z-index: 9998; padding: 10px 20px; display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #ccc; border-bottom: 2px solid #ccc; }
Â  .summary-section { position: fixed; top: 168px; left: 0; right: 0; background: #fff; z-index: 9997; padding: 10px 20px; display: flex; gap: 20px; justify-content: center; border-bottom: 1px solid #ccc; font-weight: 600; user-select: none; }
Â  .summary-item { flex: 1; text-align: center; font-size: 16px; color: #333; }
Â  .summary-value { font-size: 22px; color: #007bff; display: block; margin-top: 4px; }
Â  .main-content { margin-top: 210px; padding: 0 20px; }
Â  .chart-row { display: flex; gap: 20px; justify-content: space-between; margin: 20px 0; }
Â  .chart-box.issue { flex: 2; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
Â  .chart-box.pie { flex: 1; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
Â  .dual-table-row { display: flex; gap: 20px; margin-bottom: 20px; }
Â  .dual-table-row .full-width-table { flex: 1; max-height: 400px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
Â  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
Â  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; user-select: none; cursor: pointer; }
Â  th { background: #f0f0f0; }
Â  th.asc::after { content: " â–²"; }
Â  th.desc::after { content: " â–¼"; }
Â  .bottom-row { display: flex; gap: 20px; }
Â  .table-box { flex: 1; max-height: 320px; overflow-y: auto; }
Â  .iframe-box { flex: 2; }
Â  iframe { width: 100%; height: 300px; border: none; border-radius: 10px; }
Â  .clickable { color: blue; text-decoration: underline; cursor: pointer; }
Â  .chart-container { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; }
Â  #severityTrendChart, #issueTrendChart { height: 300px; }
Â  .summary-tables { margin-top: 30px; }

Â  /* Tab content show/hide */
Â  .tab-content { display: none; }
Â  .tab-content.active { display: block; }
</style>
</head>
<body>

<div class="header-bar">360 Issue Dashboard</div>

<div class="tabs">
Â  <div class="tab active" data-tab="dashboardTab">Dashboard</div>
Â  <div class="tab" data-tab="summaryTab">Summary</div>
</div>

<div class="filters" id="filtersSection">
Â  <select id="monthFilter" data-label="Month"><option value="">Month</option></select>
Â  <select id="severityFilter" data-label="Severity"><option value="">Severity</option></select>
Â  <select id="issueFilter" data-label="Issue"><option value="">Issue</option></select>
Â  <select id="enterpriseFilter" data-label="Enterprise"><option value="">Enterprise</option></select>
Â  <select id="productTypeFilter" data-label="Product_Type"><option value="">Product Type</option></select>
Â  <select id="qcFilter" data-label="QC"><option value="">QC</option></select>
Â  <button onclick="resetFilters()">Reset</button>
</div>

<div class="summary-bar" id="summaryBar">
Â  <div>Total Marked Spin: <span id="markedSpin">0</span></div>
Â  <div>
Â  Â  <button onclick="loadAndRender()" title="Refresh" style="background:none;border:none;cursor:pointer;font-size:18px;">ðŸ”„</button>
Â  Â  <button onclick="exportTableToCSV('spin-data.csv')" title="Export CSV" style="background:none;border:none;cursor:pointer;font-size:18px;">ðŸ“¤</button>
Â  </div>
Â  <div>Total Received Spin: <span id="receivedSpin">0</span></div>
</div>

<div class="summary-section" id="summarySection">
Â  <div class="summary-item">Total Spins <span class="summary-value" id="totalSpins">0</span></div>
Â  <div class="summary-item">Unique Issues <span class="summary-value" id="uniqueIssues">0</span></div>
Â  <div class="summary-item">Unique Enterprises <span class="summary-value" id="uniqueEnterprises">0</span></div>
Â  <div class="summary-item">Blocker Issues <span class="summary-value" id="blockerIssues">0</span></div>
Â  <div class="summary-item">High Severity <span class="summary-value" id="highIssues">0</span></div>
Â  <div class="summary-item">Low Severity <span class="summary-value" id="lowIssues">0</span></div>
Â  <div class="summary-item">Remove BG % <span class="summary-value" id="removeBgPercentage">0%</span></div>
</div>

<div class="main-content tab-content active" id="dashboardTab">
Â  <div class="chart-row">
Â  Â  <div class="chart-box issue"><canvas id="issueChart"></canvas></div>
Â  Â  <div class="chart-box pie"><canvas id="severityPie"></canvas></div>
Â  </div>
Â  <div class="dual-table-row">
Â  Â  <div class="full-width-table">
Â  Â  Â  <h3>Issue</h3>
Â  Â  Â  <table id="issueSummary">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>Issue</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">Total</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">Blocker</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">High</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">Low</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div class="full-width-table">
Â  Â  Â  <h3>Enterprise</h3>
Â  Â  Â  <table id="enterpriseSummary">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>Enterprise</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">Total</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">Blocker</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">High</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortTable(this)">Low</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  </div>
Â  <div class="bottom-row">
Â  Â  <div class="table-box">
Â  Â  Â  <table id="spinTable">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr><th>Spin ID</th><th>Issue</th><th>Severity</th><th>Enterprise</th></tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div class="iframe-box">
Â  Â  Â  <iframe id="spinIframe" title="Spin Preview"></iframe>
Â  Â  Â  <a id="spinDownloadLink" href="#" download="spin-data.csv" style="display: none;">Download Spin Data</a>
Â  Â  </div>
Â  </div>
</div>

<div class="main-content tab-content" id="summaryTab">
Â  <div class="chart-row">
Â  Â  <div class="chart-container">
Â  Â  Â  <h3>Severity Trend (%)</h3>
Â  Â  Â  <canvas id="severityTrendChart"></canvas>
Â  Â  </div>
Â  Â  <div class="chart-container">
Â  Â  Â  <h3>Issue Trend (%)</h3>
Â  Â  Â  <canvas id="issueTrendChart"></canvas>
Â  Â  </div>
Â  </div>

Â  <div class="summary-tables">
Â  Â  <h3>Severity Details (Month-wise)</h3>
Â  Â  <table id="severityDetailsTable">
Â  Â  Â  <thead><tr id="severityDetailsHeader"><th onclick="sortTable(this)">Severity</th></tr></thead>
Â  Â  Â  <tbody id="severityDetailsBody"></tbody>
Â  Â  </table>

Â  Â  <h3>Issue Details (Month-wise)</h3>
Â  Â  <table id="issueDetailsTable">
Â  Â  Â  <thead><tr id="issueDetailsHeader"><th onclick="sortTable(this)">Issue</th></tr></thead>
Â  Â  Â  <tbody id="issueDetailsBody"></tbody>
Â  Â  </table>
Â  </div>
</div>

<script>
Â  let globalData = []; // Data from the 'Data' sheet (marked spins)
Â  let totalDataGlobal = []; // Data from the 'All-Data' sheet (all received spins)

Â  let severityTrendChartInstance = null;
Â  let issueTrendChartInstance = null;
Â  let pieChartInstance = null;
Â  let barChartInstance = null;

Â  // Function to export table data to CSV
Â  function exportTableToCSV(filename) {
Â  Â  const table = document.getElementById('spinTable'); // Use the spinTable
Â  Â  let csv = [];
Â  Â  for (let i = 0; i < table.rows.length; i++) {
Â  Â  Â  let row = [], cols = table.rows[i].querySelectorAll('td, th');
Â  Â  Â  for (let j = 0; j < cols.length; j++) {
Â  Â  Â  Â  let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
Â  Â  Â  Â  data = data.replace(/"/g, '""');
Â  Â  Â  Â  row.push(`"${data}"`);
Â  Â  Â  }
Â  Â  Â  csv.push(row.join(','));
Â  Â  }
Â  Â  let csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
Â  Â  let downloadLink = document.createElement('a');
Â  Â  downloadLink.download = filename;
Â  Â  downloadLink.href = window.URL.createObjectURL(csvFile);
Â  Â  downloadLink.style.display = 'none';
Â  Â  document.body.appendChild(downloadLink);
Â  Â  downloadLink.click();
Â  Â  document.body.removeChild(downloadLink);
Â  }

Â  // Initial load and render function
Â  async function loadAndRender() {
Â  Â  const [qcData, totalData] = await Promise.all([
Â  Â  Â  loadCSV('https://docs.google.com/spreadsheets/d/1JlcXL8X1VRxlRVGyTuLElsm9IgOiteT6amOEXrEx-jY/gviz/tq?tqx=out:csv&sheet=Data'),
Â  Â  Â  loadCSV('https://docs.google.com/spreadsheets/d/1EiI4vOQ4Fcq80YaOxosEqFZ49sftVBH-jbp4xARqfWM/gviz/tq?tqx=out:csv&sheet=All-Data')
Â  Â  ]);
Â  Â  globalData = qcData;
Â  Â  totalDataGlobal = totalData;
Â  Â  populateFilters(globalData); // Populate filters initially with all marked data
Â  Â  applyFilters(); // Apply filters to render everything
Â  }

Â  // Function to load CSV data
Â  function loadCSV(url) {
Â  Â  return fetch(url).then(res => res.text()).then(text =>
Â  Â  Â  new Promise(resolve => {
Â  Â  Â  Â  Papa.parse(text, {
Â  Â  Â  Â  Â  header: true,
Â  Â  Â  Â  Â  skipEmptyLines: true,
Â  Â  Â  Â  Â  complete: results => resolve(results.data)
Â  Â  Â  Â  });
Â  Â  Â  })
Â  Â  );
Â  }

Â  // Populates filter dropdowns with unique values from the data
Â  function populateFilters(data) {
Â  Â  const config = {
Â  Â  Â  monthFilter: 'Month', severityFilter: 'Severity', issueFilter: 'Issue',
Â  Â  Â  enterpriseFilter: 'Enterprise', productTypeFilter: 'Product_Type', qcFilter: 'QC'
Â  Â  };
Â  Â  Object.entries(config).forEach(([id, key]) => {
Â  Â  Â  const select = document.getElementById(id);
Â  Â  Â  const selectedValue = select.value; // Remember the currently selected value
Â  Â  Â  const defaultText = select.getAttribute('data-label') || key;
Â  Â  Â  const options = [...new Set(data.map(d => d[key] || '').filter(Boolean))];
Â  Â  Â  select.innerHTML = `<option value="">${defaultText}</option>` +
Â  Â  Â  Â  options.map(v => `<option value="${v}" ${v === selectedValue ? 'selected' : ''}>${v}</option>`).join('');
Â  Â  Â  select.onchange = applyFilters; // Attach event listener
Â  Â  });
Â  }

Â  // Resets all filters to their default (empty) values and reapplies them
Â  function resetFilters() {
Â  Â  const filters = document.querySelectorAll('.filters select');
Â  Â  filters.forEach(select => {
Â  Â  Â  select.value = '';
Â  Â  });
Â  Â  applyFilters();
Â  }

Â  // Applies filters to the data and updates all dashboard elements
Â  function applyFilters() {
Â  Â  const filters = {
Â  Â  Â  Month: document.getElementById('monthFilter').value,
Â  Â  Â  Severity: document.getElementById('severityFilter').value,
Â  Â  Â  Issue: document.getElementById('issueFilter').value,
Â  Â  Â  Enterprise: document.getElementById('enterpriseFilter').value,
Â  Â  Â  Product_Type: document.getElementById('productTypeFilter').value,
Â  Â  Â  QC: document.getElementById('qcFilter').value
Â  Â  };

Â  Â  // Filter for 'marked spins' (from globalData)
Â  Â  const filteredMarked = globalData.filter(row =>
Â  Â  Â  (!filters.Month || row['Month'] === filters.Month) &&
Â  Â  Â  (!filters.Severity || row['Severity'] === filters.Severity) &&
Â  Â  Â  (!filters.Issue || row['Issue'] === filters.Issue) &&
Â  Â  Â  (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
Â  Â  Â  (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
Â  Â  Â  (!filters.QC || row['QC'] === filters.QC)
Â  Â  );

Â  Â  // Filter for 'received spins' (from totalDataGlobal) - only apply filters relevant to total counts
Â  Â  const filteredReceived = totalDataGlobal.filter(row =>
Â  Â  Â  (!filters.Month || row['Month'] === filters.Month) &&
Â  Â  Â  (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
Â  Â  Â  (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
Â  Â  Â  (!filters.QC || row['QC'] === filters.QC)
Â  Â  );

Â  Â  const uniqueMarkedSpins = new Set(filteredMarked.map(r => r['Spin_id'])).size;
Â  Â  const uniqueReceivedSpins = new Set(filteredReceived.map(r => r['Spin_id'])).size;

Â  Â  document.getElementById('markedSpin').textContent = uniqueMarkedSpins;
Â  Â  document.getElementById('receivedSpin').textContent = uniqueReceivedSpins;

Â  Â  // Call the function to calculate and display all percentages based on filtered data
Â  Â  calculateAndDisplayPercentages(filteredMarked, filteredReceived);

Â  Â  populateFilters(globalData); // Repopulate filters (especially month) with ALL available data, not just filtered
Â  Â  renderIssueTable(filteredMarked, uniqueMarkedSpins);
Â  Â  renderEnterpriseIssueTable(filteredMarked, uniqueMarkedSpins);
Â  Â  renderSpinTable(filteredMarked);
Â  Â  renderPieChart(filteredMarked);
Â  Â  renderBarChart(filteredMarked);

Â  Â  renderSeverityTrendChart(filteredMarked);
Â  Â  renderIssueTrendChart(filteredMarked);
Â  Â  renderSeverityDetailsTable(filteredMarked);
Â  Â  renderIssueDetailsTable(filteredMarked);
Â  }

Â  // New function to calculate and display percentages in the summary section
Â  function calculateAndDisplayPercentages(filteredMarkedData, filteredReceivedData) {
Â  Â  const totalMarkedSpins = filteredMarkedData.length; // Count of marked spins in the current filter
Â  Â  const totalReceivedSpins = new Set(filteredReceivedData.map(r => r['Spin_id'])).size; // Count of unique received spins in the current filter

Â  Â  document.getElementById('totalSpins').textContent = totalMarkedSpins;
Â  Â  document.getElementById('uniqueIssues').textContent = new Set(filteredMarkedData.map(d => d.Issue)).size;
Â  Â  document.getElementById('uniqueEnterprises').textContent = new Set(filteredMarkedData.map(d => d.Enterprise)).size;
Â  Â  document.getElementById('blockerIssues').textContent = filteredMarkedData.filter(d => d.Severity === 'Blocker').length;
Â  Â  document.getElementById('highIssues').textContent = filteredMarkedData.filter(d => d.Severity === 'High').length;
Â  Â  document.getElementById('lowIssues').textContent = filteredMarkedData.filter(d => d.Severity === 'Low').length;

Â  Â  // Calculate 'Remove BG %' based on total received spins
Â  Â  const removeBgIssuesCount = filteredMarkedData.filter(d => d.Issue === 'Remove BG').length;
Â  Â  const removeBgPercentage = totalReceivedSpins > 0 ? ((removeBgIssuesCount / totalReceivedSpins) * 100).toFixed(1) : 0;
Â  Â  document.getElementById('removeBgPercentage').textContent = `${removeBgPercentage}%`;
Â  }

Â  // Renders the Issue Summary table
Â  function renderIssueTable(data, totalFilteredMarkedSpins) {
Â  Â  const tbody = document.getElementById('issueSummary').querySelector('tbody');
Â  Â  const issueMap = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const issue = row['Issue'] || 'Other';
Â  Â  Â  const sev = row['Severity'] || 'Low';
Â  Â  Â  if (!issueMap[issue]) issueMap[issue] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
Â  Â  Â  issueMap[issue][sev]++;
Â  Â  Â  issueMap[issue].Total++;
Â  Â  });
Â  Â  tbody.innerHTML = '';
Â  Â  // Use totalFilteredMarkedSpins for overall percentage
Â  Â  const total = totalFilteredMarkedSpins;
Â  Â  Object.entries(issueMap).forEach(([issue, s]) => {
Â  Â  Â  const totalPercentage = total > 0 ? ((s.Total / total) * 100).toFixed(1) : 0;
Â  Â  Â  const blockerPercentage = s.Total > 0 ? ((s.Blocker / s.Total) * 100).toFixed(1) : 0;
Â  Â  Â  const highPercentage = s.Total > 0 ? ((s.High / s.Total) * 100).toFixed(1) : 0;
Â  Â  Â  const lowPercentage = s.Total > 0 ? ((s.Low / s.Total) * 100).toFixed(1) : 0;

Â  Â  Â  tbody.innerHTML += `<tr><td>${issue}</td>
Â  Â  Â  Â  <td><b>${totalPercentage}%</b> (${s.Total})</td>
Â  Â  Â  Â  <td><b>${blockerPercentage}%</b> (${s.Blocker})</td>
Â  Â  Â  Â  <td><b>${highPercentage}%</b> (${s.High})</td>
Â  Â  Â  Â  <td><b>${lowPercentage}%</b> (${s.Low})</td></tr>`;
Â  Â  });
Â  }

Â  // Renders the Enterprise Summary table
Â  function renderEnterpriseIssueTable(data, totalFilteredMarkedSpins) {
Â  Â  const tbody = document.getElementById('enterpriseSummary').querySelector('tbody');
Â  Â  const enterpriseMap = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const ent = row['Enterprise'] || 'Unknown';
Â  Â  Â  const sev = row['Severity'] || 'Low';
Â  Â  Â  if (!enterpriseMap[ent]) enterpriseMap[ent] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
Â  Â  Â  enterpriseMap[ent][sev]++;
Â  Â  Â  enterpriseMap[ent].Total++;
Â  Â  });
Â  Â  tbody.innerHTML = '';
Â  Â  // Use totalFilteredMarkedSpins for overall percentage
Â  Â  const total = totalFilteredMarkedSpins;
Â  Â  Object.entries(enterpriseMap).forEach(([ent, s]) => {
Â  Â  Â  const totalPercentage = total > 0 ? ((s.Total / total) * 100).toFixed(1) : 0;
Â  Â  Â  const blockerPercentage = s.Total > 0 ? ((s.Blocker / s.Total) * 100).toFixed(1) : 0;
Â  Â  Â  const highPercentage = s.Total > 0 ? ((s.High / s.Total) * 100).toFixed(1) : 0;
Â  Â  Â  const lowPercentage = s.Total > 0 ? ((s.Low / s.Total) * 100).toFixed(1) : 0;

Â  Â  Â  tbody.innerHTML += `<tr><td>${ent}</td>
Â  Â  Â  Â  <td><b>${totalPercentage}%</b> (${s.Total})</td>
Â  Â  Â  Â  <td><b>${blockerPercentage}%</b> (${s.Blocker})</td>
Â  Â  Â  Â  <td><b>${highPercentage}%</b> (${s.High})</td>
Â  Â  Â  Â  <td><b>${lowPercentage}%</b> (${s.Low})</td></tr>`;
Â  Â  });
Â  }

Â  // Renders the Spin ID table
Â  function renderSpinTable(data) {
Â  Â  const tbody = document.getElementById('spinTable').querySelector('tbody');
Â  Â  tbody.innerHTML = '';
Â  Â  data.forEach(row => {
Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  tr.innerHTML = `<td class="clickable" onclick="document.getElementById('spinIframe').src='${row['Spin'] || '#'}'">${row['Spin_id']}</td>
Â  Â  Â  Â  <td>${row['Issue']}</td><td>${row['Severity']}</td><td>${row['Enterprise']}</td>`;
Â  Â  Â  tbody.appendChild(tr);
Â  Â  });
Â  }

Â  // Renders the Severity Pie Chart
Â  function renderPieChart(data) {
Â  Â  const sevCount = { Blocker: 0, High: 0, Low: 0 };
Â  Â  data.forEach(row => sevCount[row['Severity']] = (sevCount[row['Severity']] || 0) + 1);
Â  Â  const total = Object.values(sevCount).reduce((a, b) => a + b, 0);
Â  Â  const ctx = document.getElementById('severityPie').getContext('2d');
Â  Â  if (pieChartInstance) pieChartInstance.destroy();
Â  Â  pieChartInstance = new Chart(ctx, {
Â  Â  Â  type: 'pie',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: Object.keys(sevCount),
Â  Â  Â  Â  datasets: [{ data: Object.values(sevCount), backgroundColor: ['#FF6384', '#36A2EB', '#4BC0C0'] }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  legend: { position: 'right' },
Â  Â  Â  Â  Â  datalabels: {
Â  Â  Â  Â  Â  Â  formatter: value => `${((value / total) * 100).toFixed(1)}%`,
Â  Â  Â  Â  Â  Â  color: '#000'
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  plugins: [ChartDataLabels]
Â  Â  });
Â  }

Â  // Renders the Issue Bar Chart
Â  function renderBarChart(data) {
Â  Â  const issueCounts = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const issue = row['Issue'] || 'Other';
Â  Â  Â  issueCounts[issue] = (issueCounts[issue] || 0) + 1;
Â  Â  });
Â  Â  const total = Object.values(issueCounts).reduce((a, b) => a + b, 0);
Â  Â  const ctx = document.getElementById('issueChart').getContext('2d');
Â  Â  if (barChartInstance) barChartInstance.destroy();
Â  Â  barChartInstance = new Chart(ctx, {
Â  Â  Â  type: 'bar',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: Object.keys(issueCounts),
Â  Â  Â  Â  datasets: [{ label: 'Issue %', data: Object.values(issueCounts).map(v => ((v / total) * 100).toFixed(1)), backgroundColor: '#007bff' }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  datalabels: { anchor: 'end', align: 'end', formatter: v => `${v}%`, color: '#000' }
Â  Â  Â  Â  },
Â  Â  Â  Â  scales: { y: { beginAtZero: true } }
Â  Â  Â  },
Â  Â  Â  plugins: [ChartDataLabels]
Â  Â  });
Â  }

Â  // Renders the Severity Trend Chart
Â  function renderSeverityTrendChart(data) {
Â  Â  const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
Â  Â  const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));

Â  Â  const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));
Â  Â  const severities = Array.from(severitiesSet);

Â  Â  const totalPerMonth = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  totalPerMonth[month] = (totalPerMonth[month] || 0) + 1;
Â  Â  });

Â  Â  const matrix = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const sev = row.Severity || 'Low';
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  if (!matrix[sev]) matrix[sev] = {};
Â  Â  Â  matrix[sev][month] = (matrix[sev][month] || 0) + 1;
Â  Â  });

Â  Â  // Updated color map: Blocker is red
Â  Â  const colorsMap = {
Â  Â  Â  Blocker: '#FF0000',Â  // red
Â  Â  Â  High: '#FF6384',
Â  Â  Â  Low: '#36A2EB'
Â  Â  };
Â  Â  const colors = severities.map(sev => colorsMap[sev] || '#000000');

Â  Â  const datasets = severities.map((sev, i) => ({
Â  Â  Â  label: sev,
Â  Â  Â  data: months.map(m => {
Â  Â  Â  Â  const count = matrix[sev]?.[m] || 0;
Â  Â  Â  Â  const total = totalPerMonth[m] || 1;
Â  Â  Â  Â  return ((count / total) * 100).toFixed(1);
Â  Â  Â  }),
Â  Â  Â  borderColor: colors[i],
Â  Â  Â  backgroundColor: 'transparent',
Â  Â  Â  fill: false,
Â  Â  Â  tension: 0.3,
Â  Â  Â  pointRadius: 5,
Â  Â  Â  pointHoverRadius: 7,
Â  Â  }));

Â  Â  const ctx = document.getElementById('severityTrendChart').getContext('2d');
Â  Â  if(severityTrendChartInstance) severityTrendChartInstance.destroy();
Â  Â  severityTrendChartInstance = new Chart(ctx, {
Â  Â  Â  type: 'line',
Â  Â  Â  data: { labels: months, datasets },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  legend: { position: 'top' },
Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  mode: 'index',
Â  Â  Â  Â  Â  Â  intersect: false,
Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  datalabels: {
Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  align: 'end',
Â  Â  Â  Â  Â  Â  anchor: 'end',
Â  Â  Â  Â  Â  Â  offset: 4,
Â  Â  Â  Â  Â  Â  formatter: value => `${value}%`,
Â  Â  Â  Â  Â  Â  color: '#000',
Â  Â  Â  Â  Â  Â  font: { size: 12 }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  interaction: { mode: 'nearest', intersect: false },
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  max: 100,
Â  Â  Â  Â  Â  Â  title: { display: true, text: 'Percentage (%)' },
Â  Â  Â  Â  Â  Â  ticks: { callback: val => val + '%' }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  x: { title: { display: true, text: 'Month' } }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  plugins: [ChartDataLabels]
Â  Â  });
Â  }

Â  // Renders the Issue Trend Chart
Â  function renderIssueTrendChart(data) {
Â  Â  const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
Â  Â  const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));

Â  Â  const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));
Â  Â  const issues = Array.from(issuesSet);

Â  Â  const totalPerMonth = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  totalPerMonth[month] = (totalPerMonth[month] || 0) + 1;
Â  Â  });

Â  Â  const matrix = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const issue = row.Issue || 'Other';
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  if (!matrix[issue]) matrix[issue] = {};
Â  Â  Â  matrix[issue][month] = (matrix[issue][month] || 0) + 1;
Â  Â  });

Â  Â  const colors = ['#FF9F40', '#9966FF', '#FFCD56', '#4BC0C0', '#36A2EB', '#FF6384', '#800000', '#008000'];
Â  Â  const datasets = issues.map((issue, i) => ({
Â  Â  Â  label: issue,
Â  Â  Â  data: months.map(m => {
Â  Â  Â  Â  const count = matrix[issue]?.[m] || 0;
Â  Â  Â  Â  const total = totalPerMonth[m] || 1;
Â  Â  Â  Â  return ((count / total) * 100).toFixed(1);
Â  Â  Â  }),
Â  Â  Â  borderColor: colors[i % colors.length],
Â  Â  Â  backgroundColor: 'transparent',
Â  Â  Â  fill: false,
Â  Â  Â  tension: 0.3,
Â  Â  Â  pointRadius: 5,
Â  Â  Â  pointHoverRadius: 7,
Â  Â  Â  hidden: false
Â  Â  }));

Â  Â  datasets.unshift({
Â  Â  Â  label: 'All Issues',
Â  Â  Â  data: new Array(months.length).fill(null),
Â  Â  Â  borderColor: '#000000',
Â  Â  Â  backgroundColor: 'transparent',
Â  Â  Â  fill: false,
Â  Â  Â  pointRadius: 0,
Â  Â  Â  pointHoverRadius: 0,
Â  Â  Â  hidden: false,
Â  Â  });

Â  Â  const ctx = document.getElementById('issueTrendChart').getContext('2d');
Â  Â  if(issueTrendChartInstance) issueTrendChartInstance.destroy();

Â  Â  issueTrendChartInstance = new Chart(ctx, {
Â  Â  Â  type: 'line',
Â  Â  Â  data: { labels: months, datasets },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  position: 'top',
Â  Â  Â  Â  Â  Â  labels: {
Â  Â  Â  Â  Â  Â  Â  filter: (legendItem) => legendItem.text !== '',
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  onClick: (e, legendItem, legend) => {
Â  Â  Â  Â  Â  Â  Â  const chart = legend.chart;
Â  Â  Â  Â  Â  Â  Â  const index = legendItem.datasetIndex;

Â  Â  Â  Â  Â  Â  Â  if (index === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  chart.data.datasets.forEach((ds, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i === 0) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  ds.hidden = false;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  chart.update();
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const selectedDataset = chart.data.datasets[index];
Â  Â  Â  Â  Â  Â  Â  Â  const isHidden = selectedDataset.hidden;
Â  Â  Â  Â  Â  Â  Â  Â  const visibleCount = chart.data.datasets.filter(ds => !ds.hidden && ds !== chart.data.datasets[0]).length;

Â  Â  Â  Â  Â  Â  Â  Â  if (isHidden || visibleCount !== 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  chart.data.datasets.forEach((ds, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i === 0) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ds.hidden = i !== index;
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  chart.data.datasets.forEach((ds, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i === 0) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ds.hidden = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  chart.update();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  mode: 'index',
Â  Â  Â  Â  Â  Â  intersect: false,
Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  datalabels: {
Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  align: 'end',
Â  Â  Â  Â  Â  Â  anchor: 'end',
Â  Â  Â  Â  Â  Â  offset: 4,
Â  Â  Â  Â  Â  Â  formatter: value => `${value}%`,
Â  Â  Â  Â  Â  Â  color: '#000',
Â  Â  Â  Â  Â  Â  font: { size: 12 }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  interaction: { mode: 'nearest', intersect: false },
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  max: 100,
Â  Â  Â  Â  Â  Â  title: { display: true, text: 'Percentage (%)' },
Â  Â  Â  Â  Â  Â  ticks: { callback: val => val + '%' }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  x: { title: { display: true, text: 'Month' } }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  plugins: [ChartDataLabels]
Â  Â  });
Â  }

Â  // Renders the Severity Details Table (Month-wise)
Â  function renderSeverityDetailsTable(data) {
Â  Â  const header = document.getElementById('severityDetailsHeader');
Â  Â  const tbody = document.getElementById('severityDetailsBody');

Â  Â  const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
Â  Â  const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));

Â  Â  const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));
Â  Â  const severities = Array.from(severitiesSet);

Â  Â  header.innerHTML = '<th onclick="sortTable(this)">Severity</th>' + months.map(m => `<th onclick="sortTable(this)">${m}</th>`).join('');

Â  Â  const totalsPerMonth = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  totalsPerMonth[month] = (totalsPerMonth[month] || 0) + 1;
Â  Â  });

Â  Â  const matrix = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const sev = row.Severity || 'Low';
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  if (!matrix[sev]) matrix[sev] = {};
Â  Â  Â  matrix[sev][month] = (matrix[sev][month] || 0) + 1;
Â  Â  });

Â  Â  tbody.innerHTML = '';
Â  Â  severities.forEach(sev => {
Â  Â  Â  const rowCells = months.map(m => {
Â  Â  Â  Â  const count = matrix[sev]?.[m] || 0;
Â  Â  Â  Â  const total = totalsPerMonth[m] || 1;
Â  Â  Â  Â  const percent = ((count / total) * 100).toFixed(1);
Â  Â  Â  Â  return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
Â  Â  Â  });
Â  Â  Â  tbody.innerHTML += `<tr><td>${sev}</td>${rowCells.join('')}</tr>`;
Â  Â  });
Â  }

Â  // Renders the Issue Details Table (Month-wise)
Â  function renderIssueDetailsTable(data) {
Â  Â  const header = document.getElementById('issueDetailsHeader');
Â  Â  const tbody = document.getElementById('issueDetailsBody');

Â  Â  const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
Â  Â  const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));

Â  Â  const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));
Â  Â  const issues = Array.from(issuesSet);

Â  Â  header.innerHTML = '<th onclick="sortTable(this)">Issue</th>' + months.map(m => `<th onclick="sortTable(this)">${m}</th>`).join('');

Â  Â  const totalsPerMonth = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  totalsPerMonth[month] = (totalsPerMonth[month] || 0) + 1;
Â  Â  });

Â  Â  const matrix = {};
Â  Â  data.forEach(row => {
Â  Â  Â  const issue = row.Issue || 'Other';
Â  Â  Â  const month = row.Month || 'Unknown';
Â  Â  Â  if (!matrix[issue]) matrix[issue] = {};
Â  Â  Â  matrix[issue][month] = (matrix[issue][month] || 0) + 1;
Â  Â  });

Â  Â  tbody.innerHTML = '';
Â  Â  issues.forEach(issue => {
Â  Â  Â  const rowCells = months.map(m => {
Â  Â  Â  Â  const count = matrix[issue]?.[m] || 0;
Â  Â  Â  Â  const total = totalsPerMonth[m] || 1;
Â  Â  Â  Â  const percent = ((count / total) * 100).toFixed(1);
Â  Â  Â  Â  return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
Â  Â  Â  });
Â  Â  Â  tbody.innerHTML += `<tr><td>${issue}</td>${rowCells.join('')}</tr>`;
Â  Â  });
Â  }

Â  // Table sorting logic
Â  function sortTable(header) {
Â  Â  const table = header.closest('table');
Â  Â  const tbody = table.querySelector('tbody');
Â  Â  const index = Array.from(header.parentNode.children).indexOf(header);
Â  Â  const rows = Array.from(tbody.querySelectorAll('tr'));
Â  Â  const desc = header.classList.toggle('desc');

Â  Â  rows.sort((a,b) => {
Â  Â  Â  const valA = a.children[index].textContent.trim();
Â  Â  Â  const valB = b.children[index].textContent.trim();

Â  Â  Â  const regex = /^(\d+)(?:\s*\(\d+\.?\d*%\))?$/;
Â  Â  Â  const matchA = valA.match(regex);
Â  Â  Â  const matchB = valB.match(regex);

Â  Â  Â  if(matchA && matchB) {
Â  Â  Â  Â  const numA = parseInt(matchA[1],10);
Â  Â  Â  Â  const numB = parseInt(matchB[1],10);
Â  Â  Â  Â  return desc ? numB - numA : numA - numB;
Â  Â  Â  }

Â  Â  Â  if (valA < valB) return desc ? 1 : -1;
Â  Â  Â  if (valA > valB) return desc ? -1 : 1;
Â  Â  Â  return 0;
Â  Â  });

Â  Â  tbody.innerHTML = '';
Â  Â  rows.forEach(r => tbody.appendChild(r));
Â  Â  Array.from(header.parentNode.children).forEach(th => {
Â  Â  Â  if(th !== header) th.classList.remove('desc');
Â  Â  });
Â  }

Â  // Tab switching logic
Â  document.querySelectorAll('.tab').forEach(tab => {
Â  Â  tab.addEventListener('click', () => {
Â  Â  Â  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â  Â  Â  tab.classList.add('active');
Â  Â  Â  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
Â  Â  Â  const id = tab.getAttribute('data-tab');
Â  Â  Â  document.getElementById(id).classList.add('active');

Â  Â  Â  // Adjust visibility of filter and summary sections based on the active tab
Â  Â  Â  const showFilters = id === 'dashboardTab';
Â  Â  Â  document.getElementById('filtersSection').style.display = showFilters ? 'flex' : 'none';
Â  Â  Â  document.getElementById('summaryBar').style.display = showFilters ? 'flex' : 'none';
Â  Â  Â  document.getElementById('summarySection').style.display = showFilters ? 'flex' : 'none';
Â  Â  });
Â  });

Â  // Initial data load on window load
Â  window.onload = loadAndRender;
</script>

</body>
</html>
