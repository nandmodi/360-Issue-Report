<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
  <meta charset="UTF-8" />
  <title>360 Issue Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      padding: 20px;
      margin: 0;
    }
    h2 { font-weight: 600; margin-bottom: 10px; color: #333; }
    .summary { margin-top: 20px; background: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .filters label { font-size: 14px; color: #444; }
    .filters select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      min-width: 150px;
    }
    .container { display: flex; gap: 20px; margin-top: 20px; }
    .left-panel, .right-panel {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 10px;
      height: 400px;
      overflow-y: auto;
    }
    .left-panel { width: 40%; }
    .right-panel { flex: 1; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
      cursor: pointer;
    }
    th:hover { background: #e8f0fe; }
    tr:hover { background-color: #f4f8fc; }
    iframe {
      width: 100%;
      height: 500px;
      border: none;
      display: none;
      margin-top: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h3 { font-weight: 600; color: #2c3e50; margin-top: 30px; margin-bottom: 10px; }
    td b { color: #2c3e50; }
    .sortable::after { content: " â‡…"; font-size: 12px; color: #999; }
    .asc::after { content: " ðŸ”¼"; }
    .desc::after { content: " ðŸ”½"; }
  </style>
</head>
<body>
  <h2>360 Issue Dashboard</h2>

  <div class="filters">
    <label>Month:</label><select id="monthFilter"><option value="">All</option></select>
    <label>Severity:</label><select id="severityFilter"><option value="">All</option></select>
    <label>Issue:</label><select id="issueFilter"><option value="">All</option></select>
    <label>QC:</label><select id="qcFilter"><option value="">All</option></select>
    <label>Enterprise:</label><select id="enterpriseFilter"><option value="">All</option></select>
    <label>Product Type:</label><select id="productTypeFilter"><option value="">All</option></select>
  </div>

  <div class="summary">
    <div>Total Unique Spins: <span id="spinCount">0</span> |
    Total Spins (from Total file): <span id="totalCount">0</span></div>
    <div id="severityPercentages" style="margin-top: 20px;"></div>
  </div>

  <div class="container">
    <div class="left-panel">
      <table id="dataTable">
        <thead><tr><th>Spin ID</th><th>Issue</th><th>Severity</th><th>Enterprise</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="right-panel">
      <h3>Issue % (Based on Total Spins)</h3>
      <div id="issueSummaryBox"></div>
    </div>
  </div>

  <iframe id="spinIframe"></iframe>

<script>
const qcCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRgqnvZQd8--vubYJV2VLcPL-cQiVm-UD9ZvbcyPqW3DieFU1qz7D2jdFsifyRe9flLx3_35JGxoO-t/pub?gid=1101979832&single=true&output=csv
";      // ðŸ” Replace with your QC CSV URL
const totalCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRgqnvZQd8--vubYJV2VLcPL-cQiVm-UD9ZvbcyPqW3DieFU1qz7D2jdFsifyRe9flLx3_35JGxoO-t/pub?gid=588987298&single=true&output=csv"; // ðŸ” Replace with your Total CSV URL

let rawData = [], totalData = [];
// Fetch and load both CSVs on page load
window.addEventListener('DOMContentLoaded', async () => {
  const [qc, total] = await Promise.all([
    fetchCsv(qcCsvUrl),
    fetchCsv(totalCsvUrl)
  ]);
  rawData = qc;
  totalData = total;
  populateDropdowns([...qc, ...total]);
  renderTable(filterData(rawData));
  updateSummary();
});

async function fetchCsv(url) {
  const res = await fetch(url);
  const text = await res.text();
  const [headerLine, ...lines] = text.trim().split('\n');
  const headers = headerLine.split(',').map(h => h.trim());
  return lines.map(line => {
    const values = line.split(',');
    const row = {};
    headers.forEach((h, i) => row[h] = values[i]?.trim() || '');
    if (row['Month']) {
      const d = new Date(row['Month']);
      if (!isNaN(d)) row['Month'] = d.toLocaleString('default', { month: 'long' });
    }
    return row;
  });
}

function getFilterValues() {
  return {
    Month: document.getElementById('monthFilter').value,
    Severity: document.getElementById('severityFilter').value,
    Issue: document.getElementById('issueFilter').value,
    QC: document.getElementById('qcFilter').value,
    Enterprise: document.getElementById('enterpriseFilter').value,
    Product_Type: document.getElementById('productTypeFilter').value
  };
}

function populateDropdowns(data) {
  const keys = Object.keys(getFilterValues());
  keys.forEach(key => {
    const select = document.getElementById(key.toLowerCase() + 'Filter');
    const options = [...new Set(data.map(r => r[key]).filter(Boolean))];
    select.innerHTML = `<option value="">All</option>` +
      options.map(v => `<option value="${v}">${v}</option>`).join('');
    select.onchange = () => {
      renderTable(filterData(rawData));
      updateSummary();
    };
  });
}

function filterData(data) {
  const f = getFilterValues();
  return data.filter(r =>
    (!f.Month || r.Month === f.Month) &&
    (!f.Severity || r.Severity === f.Severity) &&
    (!f.Issue || r.Issue === f.Issue) &&
    (!f.QC || r.QC === f.QC) &&
    (!f.Enterprise || r.Enterprise === f.Enterprise) &&
    (!f.Product_Type || r.Product_Type === f.Product_Type)
  );
}

function renderTable(data) {
  const tbody = document.querySelector('#dataTable tbody');
  const iframe = document.getElementById('spinIframe');
  tbody.innerHTML = '';
  const uniqueSpins = new Set();

  data.forEach(row => {
    const id = row['Spin_id'] || '';
    if (id) uniqueSpins.add(id);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color:blue;text-decoration:underline;">${id}</td>
      <td>${row['Issue'] || ''}</td>
      <td>${row['Severity'] || ''}</td>
      <td>${row['Enterprise'] || ''}</td>`;
    tr.onclick = () => {
      if (row['Spin']) {
        iframe.src = row['Spin'];
        iframe.style.display = 'block';
      }
    };
    tbody.appendChild(tr);
  });

  document.getElementById('spinCount').textContent = uniqueSpins.size;
}

let sortColumn = null, sortDirection = 'desc';

function updateSummary() {
  const qc = filterData(rawData);
  const total = filterData(totalData);
  const spinIdKey = Object.keys(total[0] || {}).find(k => k.toLowerCase().includes('spin'));
  const totalSpins = new Set(total.map(r => r[spinIdKey]?.trim()).filter(Boolean));
  document.getElementById('totalCount').textContent = totalSpins.size;

  const stats = {};
  qc.forEach(row => {
    const issue = row.Issue || 'Unknown';
    const sev = row.Severity || 'Other';
    if (!stats[issue]) stats[issue] = { total: 0, Blocker: 0, High: 0, Low: 0 };
    stats[issue][sev]++;
    stats[issue].total++;
  });

  let rows = Object.entries(stats).map(([issue, s]) => {
    const total = s.total;
    return {
      Issue: issue,
      Total: ((total / totalSpins.size) * 100).toFixed(2),
      TotalCount: total,
      Blocker: `${((s.Blocker || 0) / total * 100).toFixed(2)}% (${s.Blocker || 0})`,
      High: `${((s.High || 0) / total * 100).toFixed(2)}% (${s.High || 0})`,
      Low: `${((s.Low || 0) / total * 100).toFixed(2)}% (${s.Low || 0})`
    };
  });

  if (sortColumn) {
    rows.sort((a, b) => {
      const valA = sortColumn === 'Issue' ? a[sortColumn] : parseFloat(a[sortColumn]);
      const valB = sortColumn === 'Issue' ? b[sortColumn] : parseFloat(b[sortColumn]);
      return sortDirection === 'asc' ? valA > valB ? 1 : -1 : valA < valB ? 1 : -1;
    });
  }

  const headers = ['Issue', 'Total', 'Blocker', 'High', 'Low'];
  const thead = `<tr>${headers.map(h =>
    `<th class="sortable ${sortColumn === h ? sortDirection : ''}" onclick="sortTable('${h}')">${h}</th>`
  ).join('')}</tr>`;

  const tbody = rows.map(r =>
    `<tr><td>${r.Issue}</td><td><b>${r.Total}%</b> (${r.TotalCount})</td><td>${r.Blocker}</td><td>${r.High}</td><td>${r.Low}</td></tr>`
  ).join('');

  document.getElementById('issueSummaryBox').innerHTML = `<table border="1">${thead}${tbody}</table>`;
}

function sortTable(col) {
  if (sortColumn === col) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortColumn = col;
    sortDirection = 'desc';
  }
  updateSummary();
}
</script>
</body>
</html>
