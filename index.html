<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>360 Issue Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #3498db;
    --secondary: #2c3e50;
    --success: #2ecc71;
    --warning: #f39c12;
    --danger: #e74c3c;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --gray: #95a5a6;
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: #f5f7fa; 
    margin: 0; 
    padding: 20px; 
    color: #333;
    line-height: 1.6;
  }
  
  .container {
    max-width: 1600px;
    margin: 0 auto;
  }
  
  /* Header and Tabs */
  .header-bar { 
    position: fixed; 
    top: 0; 
    left: 0; 
    right: 0; 
    background: var(--secondary); 
    padding: 15px 0; 
    text-align: center; 
    font-weight: bold; 
    font-size: 22px; 
    z-index: 10000; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    color: white;
  }
  
  .tabs { 
    position: fixed; 
    top: 58px; 
    left: 0; 
    right: 0; 
    background: white; 
    display: flex; 
    border-bottom: 2px solid #ddd; 
    z-index: 10000; 
  }
  
  .tab { 
    padding: 14px 24px; 
    cursor: pointer; 
    font-weight: 600; 
    color: #555; 
    border-bottom: 3px solid transparent; 
    user-select: none; 
    transition: var(--transition);
  }
  
  .tab.active { 
    color: var(--primary); 
    border-color: var(--primary); 
  }
  
  .tab:hover {
    background-color: #f8f9fa;
  }
  
  /* Filters */
  .filters { 
    position: fixed; 
    top: 98px; 
    left: 0; 
    right: 0; 
    background: #f8f9fa; 
    padding: 12px 20px; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 12px; 
    justify-content: center; 
    border-bottom: 1px solid #ddd; 
    z-index: 9999; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .filters select, .filters button { 
    padding: 8px 12px; 
    font-size: 14px; 
    border-radius: 4px; 
    border: 1px solid #ddd; 
    cursor: pointer; 
    background: white;
    transition: var(--transition);
  }
  
  .filters select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
  
  .filters button { 
    background-color: var(--primary); 
    color: white; 
    border: none; 
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .filters button:hover {
    background-color: #2980b9;
  }
  
  /* Summary Bar */
  .summary-bar { 
    position: fixed; 
    top: 142px; 
    left: 0; 
    right: 0; 
    background: white; 
    z-index: 9998; 
    padding: 12px 20px; 
    display: flex; 
    justify-content: space-between; 
    font-weight: 600; 
    border-bottom: 1px solid #ddd; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .summary-bar > div {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .summary-bar button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: var(--dark);
    transition: var(--transition);
    padding: 4px;
    border-radius: 4px;
  }
  
  .summary-bar button:hover {
    background: #f1f1f1;
    color: var(--primary);
  }
  
  /* Summary Section */
  .summary-section { 
    position: fixed; 
    top: 182px; 
    left: 0; 
    right: 0; 
    background: white; 
    z-index: 9997; 
    padding: 15px 20px; 
    display: flex; 
    gap: 20px; 
    justify-content: center; 
    border-bottom: 1px solid #ddd; 
    font-weight: 600; 
    user-select: none; 
  }
  
  .summary-item { 
    flex: 1; 
    text-align: center; 
    font-size: 16px; 
    color: #333; 
    padding: 12px;
    border-radius: 8px;
    background: #f8f9fa;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
  }
  
  .summary-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
  }
  
  .summary-value { 
    font-size: 24px; 
    color: var(--primary); 
    display: block; 
    margin-top: 6px; 
    font-weight: 700;
  }
  
  /* Main Content */
  .main-content { 
    margin-top: 240px; 
    padding: 0 20px; 
  }
  
  /* Chart and Table Containers */
  .chart-row { 
    display: flex; 
    gap: 20px; 
    justify-content: space-between; 
    margin: 20px 0; 
  }
  
  .chart-box { 
    background: #fff; 
    padding: 20px; 
    border-radius: 10px; 
    box-shadow: var(--card-shadow);
    transition: var(--transition);
  }
  
  .chart-box:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  
  .chart-box.issue { 
    flex: 2; 
  }
  
  .chart-box.pie { 
    flex: 1; 
  }
  
  .dual-table-row { 
    display: flex; 
    gap: 20px; 
    margin-bottom: 20px; 
  }
  
  .dual-table-row .full-width-table { 
    flex: 1; 
    max-height: 400px; 
    overflow-y: auto; 
    background: #fff; 
    padding: 15px; 
    border-radius: 10px; 
    box-shadow: var(--card-shadow);
  }
  
  table { 
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0;
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
  }
  
  th, td { 
    border: 1px solid #ddd; 
    padding: 12px; 
    text-align: center; 
    user-select: none; 
    cursor: pointer; 
  }
  
  th { 
    background: var(--secondary);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
  }
  
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  tr:hover {
    background-color: #f1f1f1;
  }
  
  th.asc::after { content: " ▲"; }
  th.desc::after { content: " ▼"; }
  
  .bottom-row { 
    display: flex; 
    gap: 20px; 
    margin-bottom: 30px;
  }
  
  .table-box { 
    flex: 1; 
    max-height: 320px; 
    overflow-y: auto; 
    background: #fff;
    border-radius: 10px;
    box-shadow: var(--card-shadow);
  }
  
  .iframe-box { 
    flex: 2; 
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--card-shadow);
  }
  
  iframe { 
    width: 100%; 
    height: 300px; 
    border: none; 
    border-radius: 10px; 
  }
  
  .clickable { 
    color: var(--primary); 
    text-decoration: none; 
    cursor: pointer; 
    font-weight: 600;
    transition: var(--transition);
  }
  
  .clickable:hover {
    text-decoration: underline;
  }
  
  .chart-container { 
    background: #fff; 
    padding: 20px; 
    border-radius: 10px; 
    box-shadow: var(--card-shadow);
    flex: 1; 
  }
  
  #severityTrendChart, #issueTrendChart { 
    height: 300px; 
  }
  
  .summary-tables { 
    margin-top: 30px; 
  }
  
  /* Summary Tab Filters */
  .summary-filters { 
    position: sticky; 
    top: 142px; 
    background: #f8f9fa; 
    padding: 12px 20px; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 12px; 
    justify-content: center; 
    border-bottom: 1px solid #ddd; 
    z-index: 9990; 
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  /* Tab content show/hide */
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  /* Section Headers */
  h3 {
    margin: 0 0 15px 0;
    color: var(--secondary);
    font-size: 18px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--primary);
    display: inline-block;
  }
  
  /* Status indicators */
  .status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-blocker { background-color: var(--danger); }
  .status-high { background-color: var(--warning); }
  .status-low { background-color: var(--success); }
  
  /* Percentage bars */
  .percentage-bar {
    height: 8px;
    background: #eee;
    border-radius: 4px;
    margin: 5px 0;
    overflow: hidden;
  }
  
  .percentage-fill {
    height: 100%;
    border-radius: 4px;
  }
  
  /* Card styles for summary tab */
  .metric-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: var(--card-shadow);
    margin-bottom: 20px;
  }
  
  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .metric-title {
    font-weight: 600;
    color: var(--secondary);
  }
  
  .metric-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }
  
  .metric-change {
    font-size: 14px;
    padding: 3px 8px;
    border-radius: 12px;
    background: #e8f4fc;
    color: var(--primary);
  }
  
  /* Responsive adjustments */
  @media (max-width: 1200px) {
    .chart-row, .dual-table-row, .bottom-row {
      flex-direction: column;
    }
    
    .summary-section {
      flex-wrap: wrap;
    }
    
    .summary-item {
      flex: 1 0 calc(50% - 20px);
      margin-bottom: 10px;
    }
  }
  
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    
    .filters, .summary-filters {
      flex-direction: column;
      align-items: stretch;
    }
    
    .summary-item {
      flex: 1 0 100%;
    }
    
    .main-content {
      margin-top: 320px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header-bar">
    <i class="fas fa-chart-line"></i> 360 Issue Dashboard
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="dashboardTab">
      <i class="fas fa-tachometer-alt"></i> Dashboard
    </div>
    <div class="tab" data-tab="summaryTab">
      <i class="fas fa-chart-pie"></i> Summary
    </div>
  </div>

  <div class="filters" id="filtersSection">
    <select id="monthFilter" data-label="Month"><option value="">Month</option></select>
    <select id="severityFilter" data-label="Severity"><option value="">Severity</option></select>
    <select id="issueFilter" data-label="Issue"><option value="">Issue</option></select>
    <select id="enterpriseFilter" data-label="Enterprise"><option value="">Enterprise</option></select>
    <select id="productTypeFilter" data-label="Product_Type"><option value="">Product Type</option></select>
    <select id="qcFilter" data-label="QC"><option value="">QC</option></select>
    <button onclick="resetFilters()"><i class="fas fa-sync-alt"></i> Reset</button>
  </div>

  <div class="summary-bar" id="summaryBar">
    <div>Total Marked Spin: <span id="markedSpin">0</span></div>
    <div>
      <button onclick="loadAndRender()" title="Refresh"><i class="fas fa-sync"></i></button>
      <button onclick="exportTableToCSV('spin-data.csv')" title="Export CSV"><i class="fas fa-download"></i></button>
    </div>
    <div>Total Received Spin: <span id="receivedSpin">0</span></div>
  </div>

  <div class="summary-section" id="summarySection">
    <div class="summary-item">
      <i class="fas fa-cube" style="color: #3498db;"></i> Total Spins 
      <span class="summary-value" id="totalSpins">0</span>
    </div>
    <div class="summary-item">
      <i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i> Unique Issues 
      <span class="summary-value" id="uniqueIssues">0</span>
    </div>
    <div class="summary-item">
      <i class="fas fa-building" style="color: #2ecc71;"></i> Unique Enterprises 
      <span class="summary-value" id="uniqueEnterprises">0</span>
    </div>
    <div class="summary-item">
      <i class="fas fa-ban" style="color: #e74c3c;"></i> Blocker Issues 
      <span class="summary-value" id="blockerIssues">0</span>
    </div>
    <div class="summary-item">
      <i class="fas fa-arrow-up" style="color: #f39c12;"></i> High Severity 
      <span class="summary-value" id="highIssues">0</span>
    </div>
    <div class="summary-item">
      <i class="fas fa-arrow-down" style="color: #2ecc71;"></i> Low Severity 
      <span class="summary-value" id="lowIssues">0</span>
    </div>
  </div>

  <!-- Dashboard Tab -->
  <div class="main-content tab-content active" id="dashboardTab">
    <div class="chart-row">
      <div class="chart-box issue">
        <h3><i class="fas fa-chart-bar"></i> Issue Distribution</h3>
        <canvas id="issueChart"></canvas>
      </div>
      <div class="chart-box pie">
        <h3><i class="fas fa-chart-pie"></i> Severity Distribution</h3>
        <canvas id="severityPie"></canvas>
      </div>
    </div>
    <div class="dual-table-row">
      <div class="full-width-table">
        <h3><i class="fas fa-exclamation-circle"></i> Issue Summary</h3>
        <table id="issueSummary">
          <thead>
            <tr>
              <th>Issue</th>
              <th onclick="sortTable(this)">Total</th>
              <th onclick="sortTable(this)">Blocker</th>
              <th onclick="sortTable(this)">High</th>
              <th onclick="sortTable(this)">Low</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="full-width-table">
        <h3><i class="fas fa-building"></i> Enterprise Summary</h3>
        <table id="enterpriseSummary">
          <thead>
            <tr>
              <th>Enterprise</th>
              <th onclick="sortTable(this)">Total</th>
              <th onclick="sortTable(this)">Blocker</th>
              <th onclick="sortTable(this)">High</th>
              <th onclick="sortTable(this)">Low</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="bottom-row">
      <div class="table-box">
        <h3><i class="fas fa-list"></i> Spin Details</h3>
        <table id="spinTable">
          <thead>
            <tr>
              <th>Spin ID</th>
              <th>Issue</th>
              <th>Severity</th>
              <th>Enterprise</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="iframe-box">
        <h3><i class="fas fa-eye"></i> Spin Preview</h3>
        <iframe id="spinIframe" title="Spin Preview"></iframe>
      </div>
    </div>
  </div>

  <!-- Summary Tab -->
  <div class="main-content tab-content" id="summaryTab">
    <!-- Removed duplicate filters section from summary tab -->
    <!-- Now using the main filters for both tabs -->

    <div class="metric-card">
      <div class="metric-header">
        <div class="metric-title">Monthly Overview</div>
        <div class="metric-change">+2.5% from last month</div>
      </div>
      <div class="metric-value">37.6%</div>
      <div class="percentage-bar">
        <div class="percentage-fill" style="width: 37.6%; background-color: #3498db;"></div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Severity Trend (%)</h3>
        <canvas id="severityTrendChart"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Issue Trend (%)</h3>
        <canvas id="issueTrendChart"></canvas>
      </div>
    </div>

    <div class="summary-tables">
      <h3><i class="fas fa-table"></i> Severity Details (Month-wise)</h3>
      <table id="severityDetailsTable">
        <thead>
          <tr id="severityDetailsHeader">
            <th onclick="sortTable(this)">Severity</th>
            <th onclick="sortTable(this)">September</th>
            <th onclick="sortTable(this)">August</th>
            <th onclick="sortTable(this)">July</th>
            <th onclick="sortTable(this)">June</th>
          </tr>
        </thead>
        <tbody id="severityDetailsBody">
          <tr>
            <td><span class="status-indicator status-high"></span> High</td>
            <td>3197 <span style="font-size:0.8em; color:#666;">(74.1%)</span></td>
            <td>21525 <span style="font-size:0.8em; color:#666;">(69.0%)</span></td>
            <td>17045 <span style="font-size:0.8em; color:#666;">(62.2%)</span></td>
            <td>5435 <span style="font-size:0.8em; color:#666;">(34.8%)</span></td>
          </tr>
          <tr>
            <td><span class="status-indicator status-low"></span> Low</td>
            <td>1104 <span style="font-size:0.8em; color:#666;">(25.6%)</span></td>
            <td>13704 <span style="font-size:0.8em; color:#666;">(37.6%)</span></td>
            <td>14229 <span style="font-size:0.8em; color:#666;">(43.9%)</span></td>
            <td>10023 <span style="font-size:0.8em; color:#666;">(83.7%)</span></td>
          </tr>
          <tr>
            <td><span class="status-indicator status-blocker"></span> Blocker</td>
            <td>11 <span style="font-size:0.8em; color:#666;">(3.3%)</span></td>
            <td>1249 <span style="font-size:0.8em; color:#666;">(3.4%)</span></td>
            <td>1409 <span style="font-size:0.8em; color:#666;">(4.3%)</span></td>
            <td>265 <span style="font-size:0.8em; color:#666;">(1.7%)</span></td>
          </tr>
        </tbody>
      </table>

      <div class="summary-tables" style="margin-top: 30px;">
        <h3><i class="fas fa-table"></i> Severity Details (Week-wise)</h3>
        <table id="severityDetailsWeekTable">
          <thead>
            <tr id="severityDetailsWeekHeader">
              <th onclick="sortTable(this)">Severity</th>
              <th onclick="sortTable(this)">Week 1: Sep 1 - Sep 7</th>
              <th onclick="sortTable(this)">Week 2: Aug 25 - Aug 31</th>
              <th onclick="sortTable(this)">Week 3: Aug 18 - Aug 24</th>
              <th onclick="sortTable(this)">Week 4: Aug 11 - Aug 17</th>
            </tr>
          </thead>
          <tbody id="severityDetailsWeekBody">
            <tr>
              <td><span class="status-indicator status-high"></span> High</td>
              <td>1050 <span style="font-size:0.8em; color:#666;">(72.1%)</span></td>
              <td>4215 <span style="font-size:0.8em; color:#666;">(68.5%)</span></td>
              <td>5120 <span style="font-size:0.8em; color:#666;">(65.2%)</span></td>
              <td>4025 <span style="font-size:0.8em; color:#666;">(62.8%)</span></td>
            </tr>
            <tr>
              <td><span class="status-indicator status-low"></span> Low</td>
              <td>380 <span style="font-size:0.8em; color:#666;">(26.1%)</span></td>
              <td>1750 <span style="font-size:0.8em; color:#666;">(28.4%)</span></td>
              <td>2550 <span style="font-size:0.8em; color:#666;">(32.5%)</span></td>
              <td>2250 <span style="font-size:0.8em; color:#666;">(35.1%)</span></td>
            </tr>
            <tr>
              <td><span class="status-indicator status-blocker"></span> Blocker</td>
              <td>25 <span style="font-size:0.8em; color:#666;">(1.7%)</span></td>
              <td>185 <span style="font-size:0.8em; color:#666;">(3.0%)</span></td>
              <td>170 <span style="font-size:0.8em; color:#666;">(2.2%)</span></td>
              <td>140 <span style="font-size:0.8em; color:#666;">(2.2%)</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3 style="margin-top: 30px;"><i class="fas fa-table"></i> Issue Details (Month-wise)</h3>
      <table id="issueDetailsTable">
        <thead>
          <tr id="issueDetailsHeader">
            <th onclick="sortTable(this)">Issue</th>
            <th onclick="sortTable(this)">September</th>
            <th onclick="sortTable(this)">August</th>
            <th onclick="sortTable(this)">July</th>
            <th onclick="sortTable(this)">June</th>
            </tr>
        </thead>
        <tbody id="issueDetailsBody">
          <tr>
            <td>Loading Error</td>
            <td>1250 <span style="font-size:0.8em; color:#666;">(29.0%)</span></td>
            <td>8520 <span style="font-size:0.8em; color:#666;">(27.3%)</span></td>
            <td>7025 <span style="font-size:0.8em; color:#666;">(25.6%)</span></td>
            <td>2125 <span style="font-size:0.8em; color:#666;">(13.6%)</span></td>
          </tr>
          <tr>
            <td>Rendering Issue</td>
            <td>980 <span style="font-size:0.8em; color:#666;">(22.7%)</span></td>
            <td>7025 <span style="font-size:0.8em; color:#666;">(22.5%)</span></td>
            <td>6025 <span style="font-size:0.8em; color:#666;">(22.0%)</span></td>
            <td>1850 <span style="font-size:0.8em; color:#666;">(11.8%)</span></td>
          </tr>
          <tr>
            <td>Performance</td>
            <td>750 <span style="font-size:0.8em; color:#666;">(17.4%)</span></td>
            <td>5520 <span style="font-size:0.8em; color:#666;">(17.7%)</span></td>
            <td>5025 <span style="font-size:0.8em; color:#666;">(18.3%)</span></td>
            <td>1525 <span style="font-size:0.8em; color:#666;">(9.8%)</span></td>
          </tr>
        </tbody>
      </table>

      <div class="summary-tables" style="margin-top: 30px;">
        <h3><i class="fas fa-table"></i> Issue Details (Week-wise)</h3>
        <table id="issueDetailsWeekTable">
          <thead>
            <tr id="issueDetailsWeekHeader">
              <th onclick="sortTable(this)">Issue</th>
              <th onclick="sortTable(this)">Week 1: Sep 1 - Sep 7</th>
              <th onclick="sortTable(this)">Week 2: Aug 25 - Aug 31</th>
              <th onclick="sortTable(this)">Week 3: Aug 18 - Aug 24</th>
              <th onclick="sortTable(this)">Week 4: Aug 11 - Aug 17</th>
            </tr>
          </thead>
          <tbody id="issueDetailsWeekBody">
            <tr>
              <td>Loading Error</td>
              <td>450 <span style="font-size:0.8em; color:#666;">(30.9%)</span></td>
              <td>1920 <span style="font-size:0.8em; color:#666;">(31.2%)</span></td>
              <td>2425 <span style="font-size:0.8em; color:#666;">(30.9%)</span></td>
              <td>2025 <span style="font-size:0.8em; color:#666;">(31.6%)</span></td>
            </tr>
            <tr>
              <td>Rendering Issue</td>
              <td>350 <span style="font-size:0.8em; color:#666;">(24.0%)</span></td>
              <td>1520 <span style="font-size:0.8em; color:#666;">(24.7%)</span></td>
              <td>1925 <span style="font-size:0.8em; color:#666;">(24.5%)</span></td>
              <td>1625 <span style="font-size:0.8em; color:#666;">(25.4%)</span></td>
            </tr>
            <tr>
              <td>Performance</td>
              <td>280 <span style="font-size:0.8em; color:#666;">(19.2%)</span></td>
              <td>1220 <span style="font-size:0.8em; color:#666;">(19.8%)</span></td>
              <td>1525 <span style="font-size:0.8em; color:#666;">(19.4%)</span></td>
              <td>1225 <span style="font-size:0.8em; color:#666;">(19.1%)</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // JavaScript code from the original remains unchanged
  let globalData = [];
  let totalDataGlobal = [];
  let weekRanges = {};

  let severityTrendChartInstance = null;
  let issueTrendChartInstance = null;
  let pieChartInstance = null;
  let barChartInstance = null;

  async function loadAndRender() {
    const [qcData, totalData] = await Promise.all([
      loadCSV('https://docs.google.com/spreadsheets/d/1JlcXL8X1VRxlRVGyTuLElsm9IgOiteT6amOEXrEx-jY/gviz/tq?tqx=out:csv&sheet=Data'),
      loadCSV('https://docs.google.com/spreadsheets/d/1EiI4vOQ4Fcq80YaOxosEqFZ49sftVBH-jbp4xARqfWM/gviz/tq?tqx=out:csv&sheet=All-Data')
    ]);
    globalData = qcData;
    totalDataGlobal = totalData;
    calculateLastFourWeeks();
    applyFilters();
  }

  function loadCSV(url) {
    return fetch(url).then(res => res.text()).then(text =>
      new Promise(resolve => {
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: results => resolve(results.data)
        });
      })
    );
  }

  // Helper function to format week range strings
  function getFormattedWeekRange(start, end) {
    const startMonth = start.toLocaleString('default', { month: 'short' });
    const endMonth = end.toLocaleString('default', { month: 'short' });
    const startDay = start.getDate();
    const endDay = end.getDate();
    return `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
  }

  // This function dynamically calculates the last four complete weeks.
  function calculateLastFourWeeks() {
    weekRanges = {};
    const today = new Date();
    // Start with the most recent Sunday as the end of the first week.
    // getDay() returns 0 for Sunday, so we subtract that many days to get to the Sunday of the current week.
    const lastSunday = new Date(today.setDate(today.getDate() - today.getDay()));

    for (let i = 0; i < 4; i++) {
        // Create a new date object for the end of the week, moving back 7 days each iteration.
        const weekEndDate = new Date(lastSunday.getTime());
        weekEndDate.setDate(lastSunday.getDate() - (i * 7));
        
        // Calculate the start date for the week (7 days before end date)
        const weekStartDate = new Date(weekEndDate.getTime());
        weekStartDate.setDate(weekEndDate.getDate() - 6);

        // This is the dynamic label for the filter dropdown
        const weekName = `Week ${i + 1}`;
        weekRanges[weekName] = { 
            name: `${weekName}: ${getFormattedWeekRange(weekStartDate, weekEndDate)}`,
            start: weekStartDate,
            end: weekEndDate 
        };
    }
  }

  function resetFilters() {
    document.getElementById('monthFilter').value = '';
    document.getElementById('severityFilter').value = '';
    document.getElementById('issueFilter').value = '';
    document.getElementById('enterpriseFilter').value = '';
    document.getElementById('productTypeFilter').value = '';
    document.getElementById('qcFilter').value = '';
    applyFilters();
  }

  function populateFilters(data) {
    const config = {
      monthFilter: 'Month', severityFilter: 'Severity', issueFilter: 'Issue',
      enterpriseFilter: 'Enterprise', productTypeFilter: 'Product_Type', qcFilter: 'QC'
    };
    Object.entries(config).forEach(([id, key]) => {
      const select = document.getElementById(id);
      const selectedValue = select.value;
      const defaultText = select.getAttribute('data-label') || key;
      let options = [...new Set(data.map(d => d[key] || '').filter(Boolean))];

      if (id === 'monthFilter') {
        // Display the dynamic week ranges in the dropdown, with Week 1 at the top.
        const weekOptions = Object.values(weekRanges).map(w => w.name).reverse();
        options = [...options, ...weekOptions];
      }

      select.innerHTML = `<option value="">${defaultText}</option>` +
        options.map(v => `<option value="${v}" ${v === selectedValue ? 'selected' : ''}>${v}</option>`).join('');
      select.onchange = applyFilters;
    });
  }

  function applyFilters() {
    const filters = {
      Month: document.getElementById('monthFilter').value,
      Severity: document.getElementById('severityFilter').value,
      Issue: document.getElementById('issueFilter').value,
      Enterprise: document.getElementById('enterpriseFilter').value,
      Product_Type: document.getElementById('productTypeFilter').value,
      QC: document.getElementById('qcFilter').value
    };

    // Find the week range object that matches the selected filter name.
    const weekFilterKey = Object.keys(weekRanges).find(key => weekRanges[key].name === filters.Month);
    const isWeekFilter = !!weekFilterKey;
    const weekRange = isWeekFilter ? weekRanges[weekFilterKey] : null;

    const markedMatch = row => {
      const rowDate = row['Date'] ? new Date(row['Date']) : null;
      if (!rowDate) return false;

      const rowMonth = row['Month'];
      
      const monthMatch = !filters.Month || (
        !isWeekFilter && rowMonth === filters.Month
      ) || (
        isWeekFilter && rowDate >= weekRange.start && rowDate <= weekRange.end
      );

      return monthMatch &&
        (!filters.Severity || row['Severity'] === filters.Severity) &&
        (!filters.Issue || row['Issue'] === filters.Issue) &&
        (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
        (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
        (!filters.QC || row['QC'] === filters.QC);
    };

    const receivedMatch = row => {
      const rowDate = row['Date'] ? new Date(row['Date']) : null;
      if (!rowDate) return false;

      const rowMonth = row['Month'];
      
      const monthMatch = !filters.Month || (
        !isWeekFilter && rowMonth === filters.Month
      ) || (
        isWeekFilter && rowDate >= weekRange.start && rowDate <= weekRange.end
      );

      return monthMatch &&
        (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
        (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
        (!filters.QC || row['QC'] === filters.QC);
    };

    const filteredMarked = globalData.filter(markedMatch);
    const filteredReceived = totalDataGlobal.filter(receivedMatch);

    document.getElementById('markedSpin').textContent = new Set(filteredMarked.map(r => r['Spin_id'])).size;
    document.getElementById('receivedSpin').textContent = new Set(filteredReceived.map(r => r['Spin_id'])).size;

    populateSummarySection(filteredMarked);

    populateFilters(globalData);
    renderIssueTable(filteredMarked);
    renderEnterpriseIssueTable(filteredMarked);
    renderSpinTable(filteredMarked);
    renderPieChart(filteredMarked);
    renderBarChart(filteredMarked);

    // Update summary tab with the same filtered data
    renderSeverityTrendChart(filteredMarked);
    renderIssueTrendChart(filteredMarked);
    renderSeverityDetailsTable(filteredMarked);
    renderIssueDetailsTable(filteredMarked);
    renderSeverityDetailsWeekTable(filteredMarked);
    renderIssueDetailsWeekTable(filteredMarked);
  }

  function populateSummarySection(data) {
    document.getElementById('totalSpins').textContent = data.length;
    document.getElementById('uniqueIssues').textContent = new Set(data.map(d => d.Issue)).size;
    document.getElementById('uniqueEnterprises').textContent = new Set(data.map(d => d.Enterprise)).size;
    document.getElementById('blockerIssues').textContent = data.filter(d => d.Severity === 'Blocker').length;
    document.getElementById('highIssues').textContent = data.filter(d => d.Severity === 'High').length;
    document.getElementById('lowIssues').textContent = data.filter(d => d.Severity === 'Low').length;
  }

  function renderIssueTable(data) {
    const tbody = document.getElementById('issueSummary').querySelector('tbody');
    const issueMap = {};
    data.forEach(row => {
      const issue = row['Issue'] || 'Other';
      const sev = row['Severity'] || 'Low';
      if (!issueMap[issue]) issueMap[issue] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
      issueMap[issue][sev]++;
      issueMap[issue].Total++;
    });
    tbody.innerHTML = '';
    const total = data.length;
    Object.entries(issueMap).forEach(([issue, s]) => {
      tbody.innerHTML += `<tr><td>${issue}</td>
  <td><b>${((s.Total / total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.Total})</span></td>
  <td><b>${((s.Blocker / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.Blocker})</span></td>
  <td><b>${((s.High / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.High})</span></td>
  <td><b>${((s.Low / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.Low})</span></td></tr>`;
    });
  }

  function renderEnterpriseIssueTable(data) {
    const tbody = document.getElementById('enterpriseSummary').querySelector('tbody');
    const enterpriseMap = {};
    data.forEach(row => {
      const ent = row['Enterprise'] || 'Unknown';
      const sev = row['Severity'] || 'Low';
      if (!enterpriseMap[ent]) enterpriseMap[ent] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
      enterpriseMap[ent][sev]++;
      enterpriseMap[ent].Total++;
    });
    tbody.innerHTML = '';
    const total = data.length;
    Object.entries(enterpriseMap).forEach(([ent, s]) => {
      tbody.innerHTML += `<tr><td>${ent}</td>
  <td><b>${((s.Total / total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.Total})</span></td>
  <td><b>${((s.Blocker / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.Blocker})</span></td>
  <td><b>${((s.High / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.High})</span></td>
  <td><b>${((s.Low / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.6em; color: #666;">(${s.Low})</span></td></tr>`;
    });
  }

  function renderSpinTable(data) {
    const tbody = document.getElementById('spinTable').querySelector('tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="clickable" onclick="document.getElementById('spinIframe').src='${row['Spin'] || '#'}'">${row['Spin_id']}</td>
        <td>${row['Issue']}</td><td>${row['Severity']}</td><td>${row['Enterprise']}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderPieChart(data) {
    const sevCount = { Blocker: 0, High: 0, Low: 0 };
    data.forEach(row => sevCount[row['Severity']] = (sevCount[row['Severity']] || 0) + 1);
    const total = Object.values(sevCount).reduce((a, b) => a + b, 0);
    const ctx = document.getElementById('severityPie').getContext('2d');
    if (pieChartInstance) pieChartInstance.destroy();
    pieChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(sevCount),
        datasets: [{ 
          data: Object.values(sevCount), 
          backgroundColor: ['#e74c3c', '#f39c12', '#2ecc71'] 
        }]
      },
      options: {
        plugins: {
          legend: { position: 'right' },
          datalabels: {
            formatter: value => `${((value / total) * 100).toFixed(1)}%`,
            color: '#000'
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderBarChart(data) {
    const issueCounts = {};
    data.forEach(row => {
      const issue = row['Issue'] || 'Other';
      issueCounts[issue] = (issueCounts[issue] || 0) + 1;
    });
    const total = Object.values(issueCounts).reduce((a, b) => a + b, 0);
    const ctx = document.getElementById('issueChart').getContext('2d');
    if (barChartInstance) barChartInstance.destroy();
    barChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(issueCounts),
        datasets: [{ 
          label: 'Issue %', 
          data: Object.values(issueCounts).map(v => ((v / total) * 100).toFixed(1)), 
          backgroundColor: '#3498db' 
        }]
      },
      options: {
        plugins: {
          datalabels: { anchor: 'end', align: 'end', formatter: v => `${v}%`, color: '#000' }
        },
        scales: { y: { beginAtZero: true } }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderSeverityTrendChart(data) {
    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));

    const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));
    const severities = Array.from(severitiesSet);

    const totalPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      totalPerMonth[month] = (totalPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const sev = row.Severity || 'Low';
      const month = row.Month || 'Unknown';
      if (!matrix[sev]) matrix[sev] = {};
      matrix[sev][month] = (matrix[sev][month] || 0) + 1;
    });

    // Updated color map: Blocker is red
    const colorsMap = {
      Blocker: '#e74c3c',  // red
      High: '#f39c12',
      Low: '#2ecc71'
    };
    const colors = severities.map(sev => colorsMap[sev] || '#000000');

    const datasets = severities.map((sev, i) => ({
      label: sev,
      data: months.map(m => {
        const count = matrix[sev]?.[m] || 0;
        const total = totalPerMonth[m] || 1;
        return ((count / total) * 100).toFixed(1);
      }),
      borderColor: colors[i],
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7,
    }));

    const ctx = document.getElementById('severityTrendChart').getContext('2d');
    if(severityTrendChartInstance) severityTrendChartInstance.destroy();
    severityTrendChartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
            }
          },
          datalabels: {
            display: true,
            align: 'end',
            anchor: 'end',
            offset: 4,
            formatter: value => `${value}%`,
            color: '#000',
            font: { size: 12 }
          }
        },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'Percentage (%)' },
            ticks: { callback: val => val + '%' }
          },
          x: { title: { display: true, text: 'Month' } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderIssueTrendChart(data) {
    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));

    const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));
    const issues = Array.from(issuesSet);

    const totalPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      totalPerMonth[month] = (totalPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const issue = row.Issue || 'Other';
      const month = row.Month || 'Unknown';
      if (!matrix[issue]) matrix[issue] = {};
      matrix[issue][month] = (matrix[issue][month] || 0) + 1;
    });

    const colors = ['#3498db', '#9b59b6', '#e67e22', '#34495e', '#16a085', '#d35400', '#c0392b', '#8e44ad'];
    const datasets = issues.map((issue, i) => ({
      label: issue,
      data: months.map(m => {
        const count = matrix[issue]?.[m] || 0;
        const total = totalPerMonth[m] || 1;
        return ((count / total) * 100).toFixed(1);
      }),
      borderColor: colors[i % colors.length],
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7,
      hidden: false
    }));

    datasets.unshift({
      label: 'All Issues',
      data: new Array(months.length).fill(null),
      borderColor: '#000000',
      backgroundColor: 'transparent',
      fill: false,
      pointRadius: 0,
      pointHoverRadius: 0,
      hidden: false,
    });

    const ctx = document.getElementById('issueTrendChart').getContext('2d');
    if(issueTrendChartInstance) issueTrendChartInstance.destroy();

    issueTrendChartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              filter: (legendItem) => legendItem.text !== '',
            },
            onClick: (e, legendItem, legend) => {
              const chart = legend.chart;
              const index = legendItem.datasetIndex;

              if (index === 0) {
                chart.data.datasets.forEach((ds, i) => {
                  if (i === 0) return;
                  ds.hidden = false;
                });
                chart.update();
              } else {
                const selectedDataset = chart.data.datasets[index];
                const isHidden = selectedDataset.hidden;
                const visibleCount = chart.data.datasets.filter(ds => !ds.hidden && ds !== chart.data.datasets[0]).length;

                if (isHidden || visibleCount !== 1) {
                  chart.data.datasets.forEach((ds, i) => {
                    if (i === 0) return;
                    ds.hidden = i !== index;
                  });
                } else {
                  chart.data.datasets.forEach((ds, i) => {
                    if (i === 0) return;
                    ds.hidden = false;
                  });
                }
                chart.update();
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
            }
          },
          datalabels: {
            display: true,
            align: 'end',
            anchor: 'end',
            offset: 4,
            formatter: value => `${value}%`,
            color: '#000',
            font: { size: 12 }
          }
        },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'Percentage (%)' },
            ticks: { callback: val => val + '%' }
          },
          x: { title: { display: true, text: 'Month' } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderSeverityDetailsTable(data) {
    const header = document.getElementById('severityDetailsHeader');
    const tbody = document.getElementById('severityDetailsBody');

    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));

    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));
    const severities = Array.from(severitiesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Severity</th>' + months.map(m => `<th onclick="sortTable(this)">${m}</th>`).join('');

    const totalsPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      totalsPerMonth[month] = (totalsPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const sev = row.Severity || 'Low';
      const month = row.Month || 'Unknown';
      if (!matrix[sev]) matrix[sev] = {};
      matrix[sev][month] = (matrix[sev][month] || 0) + 1;
    });

    tbody.innerHTML = '';
    severities.forEach(sev => {
      const rowCells = months.map(m => {
        const count = matrix[sev]?.[m] || 0;
        const total = totalsPerMonth[m] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${sev}</td>${rowCells.join('')}</tr>`;
    });
  }

  function renderIssueDetailsTable(data) {
    const header = document.getElementById('issueDetailsHeader');
    const tbody = document.getElementById('issueDetailsBody');

    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));

    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));
    const issues = Array.from(issuesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Issue</th>' + months.map(m => `<th onclick="sortTable(this)">${m}</th>`).join('');

    const totalsPerMonth = {};
    data.forEach(row => {
      const month = row.Morrow || 'Unknown';
      totalsPerMonth[month] = (totalsPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const issue = row.Issue || 'Other';
      const month = row.Month || 'Unknown';
      if (!matrix[issue]) matrix[issue] = {};
      matrix[issue][month] = (matrix[issue][month] || 0) + 1;
    });

    tbody.innerHTML = '';
    issues.forEach(issue => {
      const rowCells = months.map(m => {
        const count = matrix[issue]?.[m] || 0;
        const total = totalsPerMonth[m] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${issue}</td>${rowCells.join('')}</tr>`;
    });
  }

  function renderSeverityDetailsWeekTable(data) {
    const header = document.getElementById('severityDetailsWeekHeader');
    const tbody = document.getElementById('severityDetailsWeekBody');

    const weeks = Object.keys(weekRanges)
  .sort((a, b) => weekRanges[b].start - weekRanges[a].start)
  .map(key => weekRanges[key].name);
    const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));
    const severities = Array.from(severitiesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Severity</th>' + weeks.map(w => `<th onclick="sortTable(this)">${w}</th>`).join('');

    const totalsPerWeek = {};
    const matrix = {};

    data.forEach(row => {
      const rowDate = new Date(row['Date']);
      const weekName = Object.keys(weekRanges).find(key => 
          rowDate >= weekRanges[key].start && rowDate <= weekRanges[key].end
      );

      if (weekName) {
        const sev = row.Severity || 'Low';
        const formattedWeekName = weekRanges[weekName].name;
        
        totalsPerWeek[formattedWeekName] = (totalsPerWeek[formattedWeekName] || 0) + 1;
        if (!matrix[sev]) matrix[sev] = {};
        matrix[sev][formattedWeekName] = (matrix[sev][formattedWeekName] || 0) + 1;
      }
    });

    tbody.innerHTML = '';
    severities.forEach(sev => {
      const rowCells = weeks.map(w => {
        const count = matrix[sev]?.[w] || 0;
        const total = totalsPerWeek[w] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${sev}</td>${rowCells.join('')}</tr>`;
    });
  }

  function renderIssueDetailsWeekTable(data) {
    const header = document.getElementById('issueDetailsWeekHeader');
    const tbody = document.getElementById('issueDetailsWeekBody');

    const weeks = Object.values(weekRanges).map(w => w.name).reverse();
    const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));
    const issues = Array.from(issuesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Issue</th>' + weeks.map(w => `<th onclick="sortTable(this)">${w}</th>`).join('');

    const totalsPerWeek = {};
    const matrix = {};

    data.forEach(row => {
      const rowDate = new Date(row['Date']);
      const weekName = Object.keys(weekRanges).find(key => 
          rowDate >= weekRanges[key].start && rowDate <= weekRanges[key].end
      );

      if (weekName) {
        const issue = row.Issue || 'Other';
        const formattedWeekName = weekRanges[weekName].name;
        
        totalsPerWeek[formattedWeekName] = (totalsPerWeek[formattedWeekName] || 0) + 1;
        if (!matrix[issue]) matrix[issue] = {};
        matrix[issue][formattedWeekName] = (matrix[issue][formattedWeekName] || 0) + 1;
      }
    });

    tbody.innerHTML = '';
    issues.forEach(issue => {
      const rowCells = weeks.map(w => {
        const count = matrix[issue]?.[w] || 0;
        const total = totalsPerWeek[w] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${issue}</td>${rowCells.join('')}</tr>`;
    });
  }


  function sortTable(header) {
  const table = header.closest('table');
  const tbody = table.querySelector('tbody');
  const index = Array.from(header.parentNode.children).indexOf(header);
  const rows = Array.from(tbody.querySelectorAll('tr'));

  // Remove old sort indicators
  Array.from(header.parentNode.children).forEach(th => {
    if (th !== header) th.classList.remove('asc', 'desc');
  });

  // Determine current sort direction
  const isDesc = header.classList.contains('desc');
  header.classList.toggle('desc', !isDesc);
  header.classList.toggle('asc', isDesc);

  const parseCell = (text) => {
    const match = text.match(/([\d.]+)/); // capture the first number
    return match ? parseFloat(match[1]) : text.trim().toLowerCase();
  };

  rows.sort((a, b) => {
    const valA = parseCell(a.children[index].textContent);
    const valB = parseCell(b.children[index].textContent);

    const isNumeric = !isNaN(valA) && !isNaN(valB);
    if (isNumeric) {
      return (isDesc ? valA - valB : valB - valA); // note: reversed due to toggle
    } else {
      return isDesc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }
  });

  // Rebuild sorted tbody
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
}


  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      const id = tab.getAttribute('data-tab');
      document.getElementById(id).classList.add('active');

      // Show/hide summary bar and section based on active tab
      const showFilters = id === 'dashboardTab';
      document.getElementById('summaryBar').style.display = showFilters ? 'flex' : 'none';
      document.getElementById('summarySection').style.display = showFilters ? 'flex' : 'none';
      
      // Adjust main content margin based on which tab is active
      const mainContent = document.querySelector('.main-content');
      if (id === 'dashboardTab') {
        mainContent.style.marginTop = '240px';
      } else {
        mainContent.style.marginTop = '142px'; // Adjust for filters only
      }
    });
  });

  window.onload = loadAndRender;
</script>

</body>
</html>
