<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>360 Issue & Severity Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f8f9fa;
    margin: 0;
    padding: 20px;
  }
  h2, h3 {
    margin: 20px 0 10px 0;
    color: #007bff;
  }
  .chart-row {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
  }
  .chart-container {
    flex: 1;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  }
  canvas {
    max-width: 100%;
    height: 300px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    margin-bottom: 30px;
  }
  th, td {
    padding: 10px;
    border: 1px solid #ccc;
    text-align: center;
    user-select: none;
    cursor: pointer;
  }
  th {
    background: #e9ecef;
  }
  th.asc::after {
    content: " ▲";
  }
  th.desc::after {
    content: " ▼";
  }
  .full-width {
    width: 100%;
  }
</style>
</head>
<body>

<h2>360 Issue & Severity Dashboard</h2>

<div class="chart-row">
  <div class="chart-container">
    <h3>Severity Trend</h3>
    <canvas id="severityTrendChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>Issue Trend</h3>
    <canvas id="issueTrendChart"></canvas>
  </div>
</div>

<h3>Severity Details</h3>
<table id="severityDetailsTable" class="full-width">
  <thead>
    <tr>
      <th>Severity</th>
      <th onclick="sortTable(this)">Total</th>
      <th onclick="sortTable(this)">Blocker</th>
      <th onclick="sortTable(this)">High</th>
      <th onclick="sortTable(this)">Low</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Issue Details</h3>
<table id="issueDetailsTable" class="full-width">
  <thead>
    <tr>
      <th>Issue</th>
      <th onclick="sortTable(this)">Total</th>
      <th onclick="sortTable(this)">Blocker</th>
      <th onclick="sortTable(this)">High</th>
      <th onclick="sortTable(this)">Low</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let globalData = [];

  // Dummy sample data — replace with your CSV loading code
  const sampleData = [
    {Spin_id: 'S1', Severity: 'Blocker', Issue: 'Issue A', Month: 'Jan 2025'},
    {Spin_id: 'S2', Severity: 'High', Issue: 'Issue B', Month: 'Jan 2025'},
    {Spin_id: 'S3', Severity: 'Low', Issue: 'Issue C', Month: 'Feb 2025'},
    {Spin_id: 'S4', Severity: 'Blocker', Issue: 'Issue A', Month: 'Feb 2025'},
    {Spin_id: 'S5', Severity: 'High', Issue: 'Issue B', Month: 'Mar 2025'},
    {Spin_id: 'S6', Severity: 'Low', Issue: 'Issue C', Month: 'Mar 2025'},
    {Spin_id: 'S7', Severity: 'Blocker', Issue: 'Issue A', Month: 'Apr 2025'},
    {Spin_id: 'S8', Severity: 'High', Issue: 'Issue B', Month: 'Apr 2025'},
    {Spin_id: 'S9', Severity: 'Low', Issue: 'Issue C', Month: 'Apr 2025'}
  ];

  globalData = sampleData; // Replace this assignment with actual data load

  function renderSeverityTrendChart(data) {
    const monthsSet = new Set(data.map(d => d.Month));
    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + a) - new Date('1 ' + b));

    const severitySet = new Set(data.map(d => d.Severity));
    const severities = Array.from(severitySet);

    const matrix = {};
    data.forEach(row => {
      const sev = row.Severity;
      const month = row.Month;
      if (!matrix[sev]) matrix[sev] = {};
      matrix[sev][month] = (matrix[sev][month] || 0) + 1;
    });

    const colors = ['#FF6384', '#36A2EB', '#4BC0C0'];
    const datasets = severities.map((sev, i) => ({
      label: sev,
      data: months.map(m => matrix[sev]?.[m] || 0),
      borderColor: colors[i % colors.length],
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7
    }));

    const ctx = document.getElementById('severityTrendChart').getContext('2d');
    if(window.severityChart) window.severityChart.destroy();
    window.severityChart = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: { mode: 'index', intersect: false }
        },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Count' } },
          x: { title: { display: true, text: 'Month' } }
        }
      }
    });
  }

  function renderIssueTrendChart(data) {
    const monthsSet = new Set(data.map(d => d.Month));
    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + a) - new Date('1 ' + b));

    const issueSet = new Set(data.map(d => d.Issue));
    const issues = Array.from(issueSet);

    const matrix = {};
    data.forEach(row => {
      const issue = row.Issue;
      const month = row.Month;
      if (!matrix[issue]) matrix[issue] = {};
      matrix[issue][month] = (matrix[issue][month] || 0) + 1;
    });

    const colors = ['#FF9F40', '#9966FF', '#FFCD56', '#4BC0C0', '#36A2EB'];
    const datasets = issues.map((issue, i) => ({
      label: issue,
      data: months.map(m => matrix[issue]?.[m] || 0),
      borderColor: colors[i % colors.length],
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7
    }));

    const ctx = document.getElementById('issueTrendChart').getContext('2d');
    if(window.issueChart) window.issueChart.destroy();
    window.issueChart = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: { mode: 'index', intersect: false }
        },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Count' } },
          x: { title: { display: true, text: 'Month' } }
        }
      }
    });
  }

  function renderSeverityDetailsTable(data) {
    const tbody = document.getElementById('severityDetailsTable').querySelector('tbody');
    const map = {};
    data.forEach(row => {
      const sev = row.Severity || 'Low';
      if (!map[sev]) map[sev] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
      map[sev][sev]++;
      map[sev].Total++;
    });
    tbody.innerHTML = '';
    const total = data.length;
    Object.entries(map).forEach(([sev, counts]) => {
      tbody.innerHTML += `<tr>
        <td>${sev}</td>
        <td><b>${((counts.Total / total) * 100).toFixed(1)}%</b> (${counts.Total})</td>
        <td><b>${((counts.Blocker / counts.Total) * 100).toFixed(1)}%</b> (${counts.Blocker || 0})</td>
        <td><b>${((counts.High / counts.Total) * 100).toFixed(1)}%</b> (${counts.High || 0})</td>
        <td><b>${((counts.Low / counts.Total) * 100).toFixed(1)}%</b> (${counts.Low || 0})</td>
      </tr>`;
    });
  }

  function renderIssueDetailsTable(data) {
    const tbody = document.getElementById('issueDetailsTable').querySelector('tbody');
    const map = {};
    data.forEach(row => {
      const issue = row.Issue || 'Other';
      const sev = row.Severity || 'Low';
      if (!map[issue]) map[issue] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
      map[issue][sev]++;
      map[issue].Total++;
    });
    tbody.innerHTML = '';
    const total = data.length;
    Object.entries(map).forEach(([issue, counts]) => {
      tbody.innerHTML += `<tr>
        <td>${issue}</td>
        <td><b>${((counts.Total / total) * 100).toFixed(1)}%</b> (${counts.Total})</td>
        <td><b>${((counts.Blocker / counts.Total) * 100).toFixed(1)}%</b> (${counts.Blocker || 0})</td>
        <td><b>${((counts.High / counts.Total) * 100).toFixed(1)}%</b> (${counts.High || 0})</td>
        <td><b>${((counts.Low / counts.Total) * 100).toFixed(1)}%</b> (${counts.Low || 0})</td>
      </tr>`;
    });
  }

  function sortTable(header) {
    const table = header.closest('table');
    const tbody = table.querySelector('tbody');
    const index = Array.from(header.parentNode.children).indexOf(header);
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const desc = header.classList.toggle('desc');
    rows.sort((a,b) => {
      const getVal = row => parseFloat((row.children[index].textContent.match(/([\d.]+)%/) || [])[1] || 0);
      return desc ? getVal(b) - getVal(a) : getVal(a) - getVal(b);
    });
    tbody.innerHTML = '';
    rows.forEach(r => tbody.appendChild(r));
    Array.from(header.parentNode.children).forEach(th => {
      if(th !== header) th.classList.remove('desc');
    });
  }

  // Initialize render with sample data
  renderSeverityTrendChart(globalData);
  renderIssueTrendChart(globalData);
  renderSeverityDetailsTable(globalData);
  renderIssueDetailsTable(globalData);
</script>

</body>
</html>
