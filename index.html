<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>360 Issue Dashboard - Summary</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #3498db;
    --secondary: #2c3e50;
    --success: #2ecc71;
    --warning: #f39c12;
    --danger: #e74c3c;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --gray: #95a5a6;
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: #f5f7fa; 
    margin: 0; 
    padding: 20px; 
    color: #333;
    line-height: 1.6;
  }
  
  .container {
    max-width: 1600px;
    margin: 0 auto;
  }
  
  /* Header and Tabs */
  .header-bar { 
    position: fixed; 
    top: 0; 
    left: 0; 
    right: 0; 
    background: var(--secondary); 
    padding: 15px 0; 
    text-align: center; 
    font-weight: bold; 
    font-size: 22px; 
    z-index: 10000; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    color: white;
  }
  
  .tabs { 
    position: fixed; 
    top: 58px; 
    left: 0; 
    right: 0; 
    background: white; 
    display: flex; 
    border-bottom: 2px solid #ddd; 
    z-index: 10000; 
  }
  
  .tab { 
    padding: 14px 24px; 
    cursor: pointer; 
    font-weight: 600; 
    color: #555; 
    border-bottom: 3px solid transparent; 
    user-select: none; 
    transition: var(--transition);
  }
  
  .tab.active { 
    color: var(--primary); 
    border-color: var(--primary); 
  }
  
  .tab:hover {
    background-color: #f8f9fa;
  }
  
  /* Filters */
  .filters { 
    position: fixed; 
    top: 98px; 
    left: 0; 
    right: 0; 
    background: #f8f9fa; 
    padding: 12px 20px; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 12px; 
    justify-content: center; 
    border-bottom: 1px solid #ddd; 
    z-index: 9999; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .filters select, .filters button { 
    padding: 8px 12px; 
    font-size: 14px; 
    border-radius: 4px; 
    border: 1px solid #ddd; 
    cursor: pointer; 
    background: white;
    transition: var(--transition);
  }
  
  .filters select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
  
  .filters button { 
    background-color: var(--primary); 
    color: white; 
    border: none; 
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .filters button:hover {
    background-color: #2980b9;
  }
  
  /* Main Content */
  .main-content { 
    margin-top: 142px; 
    padding: 0 20px; 
  }
  
  /* Chart and Table Containers */
  .chart-row { 
    display: flex; 
    gap: 20px; 
    justify-content: space-between; 
    margin: 20px 0; 
  }
  
  .chart-container { 
    background: #fff; 
    padding: 20px; 
    border-radius: 10px; 
    box-shadow: var(--card-shadow);
    flex: 1; 
  }
  
  #severityTrendChart, #issueTrendChart { 
    height: 300px; 
  }
  
  .summary-tables { 
    margin-top: 30px; 
  }
  
  table { 
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0;
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
  }
  
  th, td { 
    border: 1px solid #ddd; 
    padding: 12px; 
    text-align: center; 
    user-select: none; 
    cursor: pointer; 
  }
  
  th { 
    background: var(--secondary);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
  }
  
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  tr:hover {
    background-color: #f1f1f1;
  }
  
  th.asc::after { content: " ▲"; }
  th.desc::after { content: " ▼"; }
  
  /* Status indicators */
  .status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-blocker { background-color: var(--danger); }
  .status-high { background-color: var(--warning); }
  .status-low { background-color: var(--success); }
  
  /* Percentage bars */
  .percentage-bar {
    height: 8px;
    background: #eee;
    border-radius: 4px;
    margin: 5px 0;
    overflow: hidden;
  }
  
  .percentage-fill {
    height: 100%;
    border-radius: 4px;
  }
  
  /* Card styles for summary tab */
  .metric-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: var(--card-shadow);
    margin-bottom: 20px;
  }
  
  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .metric-title {
    font-weight: 600;
    color: var(--secondary);
  }
  
  .metric-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }
  
  .metric-change {
    font-size: 14px;
    padding: 3px 8px;
    border-radius: 12px;
    background: #e8f4fc;
    color: var(--primary);
  }
  
  /* Responsive adjustments */
  @media (max-width: 1200px) {
    .chart-row {
      flex-direction: column;
    }
  }
  
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    
    .filters {
      flex-direction: column;
      align-items: stretch;
    }
    
    .main-content {
      margin-top: 180px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header-bar">
    <i class="fas fa-chart-line"></i> 360 Issue Dashboard - Summary
  </div>

  <div class="tabs">
    <div class="tab" onclick="window.location.href='dashboard.html'">
      <i class="fas fa-tachometer-alt"></i> Dashboard
    </div>
    <div class="tab active">
      <i class="fas fa-chart-pie"></i> Summary
    </div>
  </div>

  <div class="filters" id="filtersSection">
    <select id="monthFilter" data-label="Month"><option value="">Month</option></select>
    <select id="severityFilter" data-label="Severity"><option value="">Severity</option></select>
    <select id="issueFilter" data-label="Issue"><option value="">Issue</option></select>
    <select id="enterpriseFilter" data-label="Enterprise"><option value="">Enterprise</option></select>
    <select id="productTypeFilter" data-label="Product_Type"><option value="">Product Type</option></select>
    <select id="qcFilter" data-label="QC"><option value="">QC</option></select>
    <button onclick="resetFilters()"><i class="fas fa-sync-alt"></i> Reset</button>
  </div>

  <!-- Summary Tab -->
  <div class="main-content">
    <div class="metric-card">
      <div class="metric-header">
        <div class="metric-title">Monthly Overview</div>
        <div class="metric-change">+2.5% from last month</div>
      </div>
      <div class="metric-value">37.6%</div>
      <div class="percentage-bar">
        <div class="percentage-fill" style="width: 37.6%; background-color: #3498db;"></div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Severity Trend (%)</h3>
        <canvas id="severityTrendChart"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Issue Trend (%)</h3>
        <canvas id="issueTrendChart"></canvas>
      </div>
    </div>

    <div class="summary-tables">
      <h3><i class="fas fa-table"></i> Severity Details (Month-wise)</h3>
      <table id="severityDetailsTable">
        <thead>
          <tr id="severityDetailsHeader">
            <th onclick="sortTable(this)">Severity</th>
            <th onclick="sortTable(this)">September</th>
            <th onclick="sortTable(this)">August</th>
            <th onclick="sortTable(this)">July</th>
            <th onclick="sortTable(this)">June</th>
          </tr>
        </thead>
        <tbody id="severityDetailsBody">
          <tr>
            <td><span class="status-indicator status-high"></span> High</td>
            <td>3197 <span style="font-size:0.8em; color:#666;">(74.1%)</span></td>
            <td>21525 <span style="font-size:0.8em; color:#666;">(69.0%)</span></td>
            <td>17045 <span style="font-size:0.8em; color:#666;">(62.2%)</span></td>
            <td>5435 <span style="font-size:0.8em; color:#666;">(34.8%)</span></td>
          </tr>
          <tr>
            <td><span class="status-indicator status-low"></span> Low</td>
            <td>1104 <span style="font-size:0.8em; color:#666;">(25.6%)</span></td>
            <td>13704 <span style="font-size:0.8em; color:#666;">(37.6%)</span></td>
            <td>14229 <span style="font-size:0.8em; color:#666;">(43.9%)</span></td>
            <td>10023 <span style="font-size:0.8em; color:#666;">(83.7%)</span></td>
          </tr>
          <tr>
            <td><span class="status-indicator status-blocker"></span> Blocker</td>
            <td>11 <span style="font-size:0.8em; color:#666;">(3.3%)</span></td>
            <td>1249 <span style="font-size:0.8em; color:#666;">(3.4%)</span></td>
            <td>1409 <span style="font-size:0.8em; color:#666;">(4.3%)</span></td>
            <td>265 <span style="font-size:0.8em; color:#666;">(1.7%)</span></td>
          </tr>
        </tbody>
      </table>

      <div class="summary-tables" style="margin-top: 30px;">
        <h3><i class="fas fa-table"></i> Severity Details (Week-wise)</h3>
        <table id="severityDetailsWeekTable">
          <thead>
            <tr id="severityDetailsWeekHeader">
              <th onclick="sortTable(this)">Severity</th>
              <th onclick="sortTable(this)">Week 1: Sep 1 - Sep 7</th>
              <th onclick="sortTable(this)">Week 2: Aug 25 - Aug 31</th>
              <th onclick="sortTable(this)">Week 3: Aug 18 - Aug 24</th>
              <th onclick="sortTable(this)">Week 4: Aug 11 - Aug 17</th>
            </tr>
          </thead>
          <tbody id="severityDetailsWeekBody">
            <tr>
              <td><span class="status-indicator status-high"></span> High</td>
              <td>1050 <span style="font-size:0.8em; color:#666;">(72.1%)</span></td>
              <td>4215 <span style="font-size:0.8em; color:#666;">(68.5%)</span></td>
              <td>5120 <span style="font-size:0.8em; color:#666;">(65.2%)</span></td>
              <td>4025 <span style="font-size:0.8em; color:#666;">(62.8%)</span></td>
            </tr>
            <tr>
              <td><span class="status-indicator status-low"></span> Low</td>
              <td>380 <span style="font-size:0.8em; color:#666;">(26.1%)</span></td>
              <td>1750 <span style="font-size:0.8em; color:#666;">(28.4%)</span></td>
              <td>2550 <span style="font-size:0.8em; color:#666;">(32.5%)</span></td>
              <td>2250 <span style="font-size:0.8em; color:#666;">(35.1%)</span></td>
            </tr>
            <tr>
              <td><span class="status-indicator status-blocker"></span> Blocker</td>
              <td>25 <span style="font-size:0.8em; color:#666;">(1.7%)</span></td>
              <td>185 <span style="font-size:0.8em; color:#666;">(3.0%)</span></td>
              <td>170 <span style="font-size:0.8em; color:#666;">(2.2%)</span></td>
              <td>140 <span style="font-size:0.8em; color:#666;">(2.2%)</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- New Validation Failure Table -->
      <div class="summary-tables" style="margin-top: 30px;">
        <h3><i class="fas fa-table"></i> Validation Failure Details (Month-wise)</h3>
        <table id="validationFailureTable">
          <thead>
            <tr id="validationFailureHeader">
              <th onclick="sortTable(this)">Validation Type</th>
              <!-- Months will be dynamically populated -->
            </tr>
          </thead>
          <tbody id="validationFailureBody">
            <!-- Data will be dynamically populated -->
          </tbody>
        </table>
      </div>

      <h3 style="margin-top: 30px;"><i class="fas fa-table"></i> Issue Details (Month-wise)</h3>
      <table id="issueDetailsTable">
        <thead>
          <tr id="issueDetailsHeader">
            <th onclick="sortTable(this)">Issue</th>
            <th onclick="sortTable(this)">September</th>
            <th onclick="sortTable(this)">August</th>
            <th onclick="sortTable(this)">July</th>
            <th onclick="sortTable(this)">June</th>
            </tr>
        </thead>
        <tbody id="issueDetailsBody">
          <tr>
            <td>Loading Error</td>
            <td>1250 <span style="font-size:0.8em; color:#666;">(29.0%)</span></td>
            <td>8520 <span style="font-size:0.8em; color:#666;">(27.3%)</span></td>
            <td>7025 <span style="font-size:0.8em; color:#666;">(25.6%)</span></td>
            <td>2125 <span style="font-size:0.8em; color:#666;">(13.6%)</span></td>
          </tr>
          <tr>
            <td>Rendering Issue</td>
            <td>980 <span style="font-size:0.8em; color:#666;">(22.7%)</span></td>
            <td>7025 <span style="font-size:0.8em; color:#666;">(22.5%)</span></td>
            <td>6025 <span style="font-size:0.8em; color:#666;">(22.0%)</span></td>
            <td>1850 <span style="font-size:0.8em; color:#666;">(11.8%)</span></td>
          </tr>
          <tr>
            <td>Performance</td>
            <td>750 <span style="font-size:0.8em; color:#666;">(17.4%)</span></td>
            <td>5520 <span style="font-size:0.8em; color:#666;">(17.7%)</span></td>
            <td>5025 <span style="font-size:0.8em; color:#666;">(18.3%)</span></td>
            <td>1525 <span style="font-size:0.8em; color:#666;">(9.8%)</span></td>
          </tr>
        </tbody>
      </table>

      <div class="summary-tables" style="margin-top: 30px;">
        <h3><i class="fas fa-table"></i> Issue Details (Week-wise)</h3>
        <table id="issueDetailsWeekTable">
          <thead>
            <tr id="issueDetailsWeekHeader">
              <th onclick="sortTable(this)">Issue</th>
              <th onclick="sortTable(this)">Week 1: Sep 1 - Sep 7</th>
              <th onclick="sortTable(this)">Week 2: Aug 25 - Aug 31</th>
              <th onclick="sortTable(this)">Week 3: Aug 18 - Aug 24</th>
              <th onclick="sortTable(this)">Week 4: Aug 11 - Aug 17</th>
            </tr>
          </thead>
          <tbody id="issueDetailsWeekBody">
            <tr>
              <td>Loading Error</td>
              <td>450 <span style="font-size:0.8em; color:#666;">(30.9%)</span></td>
              <td>1920 <span style="font-size:0.8em; color:#666;">(31.2%)</span></td>
              <td>2425 <span style="font-size:0.8em; color:#666;">(30.9%)</span></td>
              <td>2025 <span style="font-size:0.8em; color:#666;">(31.6%)</span></td>
            </tr>
            <tr>
              <td>Rendering Issue</td>
              <td>350 <span style="font-size:0.8em; color:#666;">(24.0%)</span></td>
              <td>1520 <span style="font-size:0.8em; color:#666;">(24.7%)</span></td>
              <td>1925 <span style="font-size:0.8em; color:#666;">(24.5%)</span></td>
              <td>1625 <span style="font-size:0.8em; color:#666;">(25.4%)</span></td>
            </tr>
            <tr>
              <td>Performance</td>
              <td>280 <span style="font-size:0.8em; color:#666;">(19.2%)</span></td>
              <td>1220 <span style="font-size:0.8em; color:#666;">(19.8%)</span></td>
              <td>1525 <span style="font-size:0.8em; color:#666;">(19.4%)</span></td>
              <td>1225 <span style="font-size:0.8em; color:#666;">(19.1%)</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // JavaScript code for summary functionality
  let globalData = [];
  let totalDataGlobal = [];
  let weekRanges = {};

  let severityTrendChartInstance = null;
  let issueTrendChartInstance = null;

  async function loadAndRender() {
    const [qcData, totalData] = await Promise.all([
      loadCSV('https://docs.google.com/spreadsheets/d/1JlcXL8X1VRxlRVGyTuLElsm9IgOiteT6amOEXrEx-jY/gviz/tq?tqx=out:csv&sheet=Data'),
      loadCSV('https://docs.google.com/spreadsheets/d/1EiI4vOQ4Fcq80YaOxosEqFZ49sftVBH-jbp4xARqfWM/gviz/tq?tqx:out:csv&sheet=All-Data')
    ]);
    globalData = qcData;
    totalDataGlobal = totalData;
    calculateLastFourWeeks();
    applyFilters();
  }

  function loadCSV(url) {
    return fetch(url).then(res => res.text()).then(text =>
      new Promise(resolve => {
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: results => resolve(results.data)
        });
      })
    );
  }

  // Helper function to format week range strings
  function getFormattedWeekRange(start, end) {
    const startMonth = start.toLocaleString('default', { month: 'short' });
    const endMonth = end.toLocaleString('default', { month: 'short' });
    const startDay = start.getDate();
    const endDay = end.getDate();
    return `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
  }

  // This function dynamically calculates the last four complete weeks.
  function calculateLastFourWeeks() {
    weekRanges = {};
    const today = new Date();
    // Start with the most recent Sunday as the end of the first week.
    // getDay() returns 0 for Sunday, so we subtract that many days to get to the Sunday of the current week.
    const lastSunday = new Date(today.setDate(today.getDate() - today.getDay()));

    for (let i = 0; i < 4; i++) {
        // Create a new date object for the end of the week, moving back 7 days each iteration.
        const weekEndDate = new Date(lastSunday.getTime());
        weekEndDate.setDate(lastSunday.getDate() - (i * 7));
        
        // Calculate the start date for the week (7 days before end date)
        const weekStartDate = new Date(weekEndDate.getTime());
        weekStartDate.setDate(weekEndDate.getDate() - 6);

        // This is the dynamic label for the filter dropdown
        const weekName = `Week ${i + 1}`;
        weekRanges[weekName] = { 
            name: `${weekName}: ${getFormattedWeekRange(weekStartDate, weekEndDate)}`,
            start: weekStartDate,
            end: weekEndDate 
        };
    }
  }

  function resetFilters() {
    document.getElementById('monthFilter').value = '';
    document.getElementById('severityFilter').value = '';
    document.getElementById('issueFilter').value = '';
    document.getElementById('enterpriseFilter').value = '';
    document.getElementById('productTypeFilter').value = '';
    document.getElementById('qcFilter').value = '';
    applyFilters();
  }

  function populateFilters(data) {
    const config = {
      monthFilter: 'Month', severityFilter: 'Severity', issueFilter: 'Issue',
      enterpriseFilter: 'Enterprise', productTypeFilter: 'Product_Type', qcFilter: 'QC'
    };
    Object.entries(config).forEach(([id, key]) => {
      const select = document.getElementById(id);
      const selectedValue = select.value;
      const defaultText = select.getAttribute('data-label') || key;
      let options = [...new Set(data.map(d => d[key] || '').filter(Boolean))];

      if (id === 'monthFilter') {
        // Display the dynamic week ranges in the dropdown, with Week 1 at the top.
        const weekOptions = Object.values(weekRanges).map(w => w.name).reverse();
        options = [...options, ...weekOptions];
      }

      select.innerHTML = `<option value="">${defaultText}</option>` +
        options.map(v => `<option value="${v}" ${v === selectedValue ? 'selected' : ''}>${v}</option>`).join('');
      select.onchange = applyFilters;
    });
  }

  function applyFilters() {
    const filters = {
      Month: document.getElementById('monthFilter').value,
      Severity: document.getElementById('severityFilter').value,
      Issue: document.getElementById('issueFilter').value,
      Enterprise: document.getElementById('enterpriseFilter').value,
      Product_Type: document.getElementById('productTypeFilter').value,
      QC: document.getElementById('qcFilter').value
    };

    // Find the week range object that matches the selected filter name.
    const weekFilterKey = Object.keys(weekRanges).find(key => weekRanges[key].name === filters.Month);
    const isWeekFilter = !!weekFilterKey;
    const weekRange = isWeekFilter ? weekRanges[weekFilterKey] : null;

    const markedMatch = row => {
      const rowDate = row['Date'] ? new Date(row['Date']) : null;
      if (!rowDate) return false;

      const rowMonth = row['Month'];
      
      const monthMatch = !filters.Month || (
        !isWeekFilter && rowMonth === filters.Month
      ) || (
        isWeekFilter && rowDate >= weekRange.start && rowDate <= weekRange.end
      );

      return monthMatch &&
        (!filters.Severity || row['Severity'] === filters.Severity) &&
        (!filters.Issue || row['Issue'] === filters.Issue) &&
        (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
        (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
        (!filters.QC || row['QC'] === filters.QC);
    };

    const receivedMatch = row => {
      const rowDate = row['Date'] ? new Date(row['Date']) : null;
      if (!rowDate) return false;

      const rowMonth = row['Month'];
      
      const monthMatch = !filters.Month || (
        !isWeekFilter && rowMonth === filters.Month
      ) || (
        isWeekFilter && rowDate >= weekRange.start && rowDate <= weekRange.end
      );

      return monthMatch &&
        (!filters.Enterprise || row['Enterprise'] === filters.Enterprise) &&
        (!filters.Product_Type || row['Product_Type'] === filters.Product_Type) &&
        (!filters.QC || row['QC'] === filters.QC);
    };

    const filteredMarked = globalData.filter(markedMatch);
    const filteredReceived = totalDataGlobal.filter(receivedMatch);

    populateFilters(globalData);

    // Update summary tab with the same filtered data
    renderSeverityTrendChart(filteredMarked);
    renderIssueTrendChart(filteredMarked);
    renderSeverityDetailsTable(filteredMarked);
    renderIssueDetailsTable(filteredMarked);
    renderSeverityDetailsWeekTable(filteredMarked);
    renderIssueDetailsWeekTable(filteredMarked);
    
    // Render the new validation failure table
    renderValidationFailureTable(filteredReceived);
  }

  function renderSeverityTrendChart(data) {
    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));

    const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));
    const severities = Array.from(severitiesSet);

    const totalPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      totalPerMonth[month] = (totalPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const sev = row.Severity || 'Low';
      const month = row.Month || 'Unknown';
      if (!matrix[sev]) matrix[sev] = {};
      matrix[sev][month] = (matrix[sev][month] || 0) + 1;
    });

    // Updated color map: Blocker is red
    const colorsMap = {
      Blocker: '#e74c3c',  // red
      High: '#f39c12',
      Low: '#2ecc71'
    };
    const colors = severities.map(sev => colorsMap[sev] || '#000000');

    const datasets = severities.map((sev, i) => ({
      label: sev,
      data: months.map(m => {
        const count = matrix[sev]?.[m] || 0;
        const total = totalPerMonth[m] || 1;
        return ((count / total) * 100).toFixed(1);
      }),
      borderColor: colors[i],
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7,
    }));

    const ctx = document.getElementById('severityTrendChart').getContext('2d');
    if(severityTrendChartInstance) severityTrendChartInstance.destroy();
    severityTrendChartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
            }
          },
          datalabels: {
            display: true,
            align: 'end',
            anchor: 'end',
            offset: 4,
            formatter: value => `${value}%`,
            color: '#000',
            font: { size: 12 }
          }
        },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'Percentage (%)' },
            ticks: { callback: val => val + '%' }
          },
          x: { title: { display: true, text: 'Month' } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderIssueTrendChart(data) {
    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));

    const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));
    const issues = Array.from(issuesSet);

    const totalPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      totalPerMonth[month] = (totalPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const issue = row.Issue || 'Other';
      const month = row.Month || 'Unknown';
      if (!matrix[issue]) matrix[issue] = {};
      matrix[issue][month] = (matrix[issue][month] || 0) + 1;
    });

    const colors = ['#3498db', '#9b59b6', '#e67e22', '#34495e', '#16a085', '#d35400', '#c0392b', '#8e44ad'];
    const datasets = issues.map((issue, i) => ({
      label: issue,
      data: months.map(m => {
        const count = matrix[issue]?.[m] || 0;
        const total = totalPerMonth[m] || 1;
        return ((count / total) * 100).toFixed(1);
      }),
      borderColor: colors[i % colors.length],
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7,
      hidden: false
    }));

    datasets.unshift({
      label: 'All Issues',
      data: new Array(months.length).fill(null),
      borderColor: '#000000',
      backgroundColor: 'transparent',
      fill: false,
      pointRadius: 0,
      pointHoverRadius: 0,
      hidden: false,
    });

    const ctx = document.getElementById('issueTrendChart').getContext('2d');
    if(issueTrendChartInstance) issueTrendChartInstance.destroy();

    issueTrendChartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              filter: (legendItem) => legendItem.text !== '',
            },
            onClick: (e, legendItem, legend) => {
              const chart = legend.chart;
              const index = legendItem.datasetIndex;

              if (index === 0) {
                chart.data.datasets.forEach((ds, i) => {
                  if (i === 0) return;
                  ds.hidden = false;
                });
                chart.update();
              } else {
                const selectedDataset = chart.data.datasets[index];
                const isHidden = selectedDataset.hidden;
                const visibleCount = chart.data.datasets.filter(ds => !ds.hidden && ds !== chart.data.datasets[0]).length;

                if (isHidden || visibleCount !== 1) {
                  chart.data.datasets.forEach((ds, i) => {
                    if (i === 0) return;
                    ds.hidden = i !== index;
                  });
                } else {
                  chart.data.datasets.forEach((ds, i) => {
                    if (i === 0) return;
                    ds.hidden = false;
                  });
                }
                chart.update();
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
            }
          },
          datalabels: {
            display: true,
            align: 'end',
            anchor: 'end',
            offset: 4,
            formatter: value => `${value}%`,
            color: '#000',
            font: { size: 12 }
          }
        },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'Percentage (%)' },
            ticks: { callback: val => val + '%' }
          },
          x: { title: { display: true, text: 'Month' } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderSeverityDetailsTable(data) {
    const header = document.getElementById('severityDetailsHeader');
    const tbody = document.getElementById('severityDetailsBody');

    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));

    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));
    const severities = Array.from(severitiesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Severity</th>' + months.map(m => `<th onclick="sortTable(this)">${m}</th>`).join('');

    const totalsPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      totalsPerMonth[month] = (totalsPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const sev = row.Severity || 'Low';
      const month = row.Month || 'Unknown';
      if (!matrix[sev]) matrix[sev] = {};
      matrix[sev][month] = (matrix[sev][month] || 0) + 1;
    });

    tbody.innerHTML = '';
    severities.forEach(sev => {
      const rowCells = months.map(m => {
        const count = matrix[sev]?.[m] || 0;
        const total = totalsPerMonth[m] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${sev}</td>${rowCells.join('')}</tr>`;
    });
  }

  function renderIssueDetailsTable(data) {
    const header = document.getElementById('issueDetailsHeader');
    const tbody = document.getElementById('issueDetailsBody');

    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));

    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));
    const issues = Array.from(issuesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Issue</th>' + months.map(m => `<th onclick="sortTable(this)">${m}</th>`).join('');

    const totalsPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      totalsPerMonth[month] = (totalsPerMonth[month] || 0) + 1;
    });

    const matrix = {};
    data.forEach(row => {
      const issue = row.Issue || 'Other';
      const month = row.Month || 'Unknown';
      if (!matrix[issue]) matrix[issue] = {};
      matrix[issue][month] = (matrix[issue][month] || 0) + 1;
    });

    tbody.innerHTML = '';
    issues.forEach(issue => {
      const rowCells = months.map(m => {
        const count = matrix[issue]?.[m] || 0;
        const total = totalsPerMonth[m] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${issue}</td>${rowCells.join('')}</tr>`;
    });
  }

  function renderSeverityDetailsWeekTable(data) {
    const header = document.getElementById('severityDetailsWeekHeader');
    const tbody = document.getElementById('severityDetailsWeekBody');

    const weeks = Object.keys(weekRanges)
  .sort((a, b) => weekRanges[b].start - weekRanges[a].start)
  .map(key => weekRanges[key].name);
    const severitiesSet = new Set(data.map(d => d.Severity).filter(Boolean));
    const severities = Array.from(severitiesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Severity</th>' + weeks.map(w => `<th onclick="sortTable(this)">${w}</th>`).join('');

    const totalsPerWeek = {};
    const matrix = {};

    data.forEach(row => {
      const rowDate = new Date(row['Date']);
      const weekName = Object.keys(weekRanges).find(key => 
          rowDate >= weekRanges[key].start && rowDate <= weekRanges[key].end
      );

      if (weekName) {
        const sev = row.Severity || 'Low';
        const formattedWeekName = weekRanges[weekName].name;
        
        totalsPerWeek[formattedWeekName] = (totalsPerWeek[formattedWeekName] || 0) + 1;
        if (!matrix[sev]) matrix[sev] = {};
        matrix[sev][formattedWeekName] = (matrix[sev][formattedWeekName] || 0) + 1;
      }
    });

    tbody.innerHTML = '';
    severities.forEach(sev => {
      const rowCells = weeks.map(w => {
        const count = matrix[sev]?.[w] || 0;
        const total = totalsPerWeek[w] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${sev}</td>${rowCells.join('')}</tr>`;
    });
  }

  function renderIssueDetailsWeekTable(data) {
    const header = document.getElementById('issueDetailsWeekHeader');
    const tbody = document.getElementById('issueDetailsWeekBody');

    const weeks = Object.values(weekRanges).map(w => w.name).reverse();
    const issuesSet = new Set(data.map(d => d.Issue).filter(Boolean));
    const issues = Array.from(issuesSet);

    header.innerHTML = '<th onclick="sortTable(this)">Issue</th>' + weeks.map(w => `<th onclick="sortTable(this)">${w}</th>`).join('');

    const totalsPerWeek = {};
    const matrix = {};

    data.forEach(row => {
      const rowDate = new Date(row['Date']);
      const weekName = Object.keys(weekRanges).find(key => 
          rowDate >= weekRanges[key].start && rowDate <= weekRanges[key].end
      );

      if (weekName) {
        const issue = row.Issue || 'Other';
        const formattedWeekName = weekRanges[weekName].name;
        
        totalsPerWeek[formattedWeekName] = (totalsPerWeek[formattedWeekName] || 0) + 1;
        if (!matrix[issue]) matrix[issue] = {};
        matrix[issue][formattedWeekName] = (matrix[issue][formattedWeekName] || 0) + 1;
      }
    });

    tbody.innerHTML = '';
    issues.forEach(issue => {
      const rowCells = weeks.map(w => {
        const count = matrix[issue]?.[w] || 0;
        const total = totalsPerWeek[w] || 1;
        const percent = ((count / total) * 100).toFixed(1);
        return `<td>${count} <span style="font-size:0.6em; color:#666;">(${percent}%)</span></td>`;
      });
      tbody.innerHTML += `<tr><td>${issue}</td>${rowCells.join('')}</tr>`;
    });
  }

  // New function to render validation failure table
  function renderValidationFailureTable(data) {
    const header = document.getElementById('validationFailureHeader');
    const tbody = document.getElementById('validationFailureBody');

    // Get unique months from data and sort them in descending order
    const monthsSet = new Set(data.map(d => d.Month).filter(Boolean));
    const months = Array.from(monthsSet).sort((a,b) => new Date('1 ' + b) - new Date('1 ' + a));
    
    // Get the last 4 months (current + 3 previous)
    const recentMonths = months.slice(0, 4);

    // Build header row
    header.innerHTML = '<th onclick="sortTable(this)">Validation Type</th>' + 
      recentMonths.map(m => `<th onclick="sortTable(this)">${m}</th>`).join('');

    // Calculate totals per month
    const totalsPerMonth = {};
    data.forEach(row => {
      const month = row.Month || 'Unknown';
      if (recentMonths.includes(month)) {
        totalsPerMonth[month] = (totalsPerMonth[month] || 0) + 1;
      }
    });

    // Count validation failures for each column
    const validationFailureCounts = {};
    const vdpValidationFailureCounts = {};

    data.forEach(row => {
      const month = row.Month || 'Unknown';
      if (!recentMonths.includes(month)) return;

      // Count validation_failure_reason
      if (row['validation_failure_reason'] && row['validation_failure_reason'].trim() !== '') {
        validationFailureCounts[month] = (validationFailureCounts[month] || 0) + 1;
      }

      // Count vdp_validation_failure_reason
      if (row['vdp_validation_failure_reason'] && row['vdp_validation_failure_reason'].trim() !== '') {
        vdpValidationFailureCounts[month] = (vdpValidationFailureCounts[month] || 0) + 1;
      }
    });

    // Build table body
    tbody.innerHTML = '';
    
    // Validation Failure Reason row
    const validationRowCells = recentMonths.map(m => {
      const count = validationFailureCounts[m] || 0;
      const total = totalsPerMonth[m] || 1;
      const percent = ((count / total) * 100).toFixed(1);
      return `<td>${count} <span style="font-size:0.8em; color:#666;">(${percent}%)</span></td>`;
    });
    tbody.innerHTML += `<tr><td>Validation Failure Reason</td>${validationRowCells.join('')}</tr>`;
    
    // VDP Validation Failure Reason row
    const vdpValidationRowCells = recentMonths.map(m => {
      const count = vdpValidationFailureCounts[m] || 0;
      const total = totalsPerMonth[m] || 1;
      const percent = ((count / total) * 100).toFixed(1);
      return `<td>${count} <span style="font-size:0.8em; color:#666;">(${percent}%)</span></td>`;
    });
    tbody.innerHTML += `<tr><td>VDP Validation Failure Reason</td>${vdpValidationRowCells.join('')}</tr>`;
  }

  function sortTable(header) {
  const table = header.closest('table');
  const tbody = table.querySelector('tbody');
  const index = Array.from(header.parentNode.children).indexOf(header);
  const rows = Array.from(tbody.querySelectorAll('tr'));

  // Remove old sort indicators
  Array.from(header.parentNode.children).forEach(th => {
    if (th !== header) th.classList.remove('asc', 'desc');
  });

  // Determine current sort direction
  const isDesc = header.classList.contains('desc');
  header.classList.toggle('desc', !isDesc);
  header.classList.toggle('asc', isDesc);

  const parseCell = (text) => {
    const match = text.match(/([\d.]+)/); // capture the first number
    return match ? parseFloat(match[1]) : text.trim().toLowerCase();
  };

  rows.sort((a, b) => {
    const valA = parseCell(a.children[index].textContent);
    const valB = parseCell(b.children[index].textContent);

    const isNumeric = !isNaN(valA) && !isNaN(valB);
    if (isNumeric) {
      return (isDesc ? valA - valB : valB - valA); // note: reversed due to toggle
    } else {
      return isDesc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }
  });

  // Rebuild sorted tbody
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
}

  window.onload = loadAndRender;
</script>

</body>
</html>
